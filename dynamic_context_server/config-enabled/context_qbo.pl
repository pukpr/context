:- module(context_qbo, [
			       mathieu_modulater/3,
			       yearly_qmod/2
	  ]).

:- use_module(context_math).
:- use_module(context_stats).

:- context:register(context_qbo:navigate).
:- context:register(context_qbo:plot).


% test_period(N,_,Period) :- Period is N*N/20*12+N*2.134.
test_period(_,P,P).
%diup(-0.16,-1.5,W) :- W is 2*pi/(17.8*12).
%yp(0.0,1.0).
diup(0.0,0.0,0.0) :- W is 2*pi/(17.8*12).
yp(0.0,0.0).
% diup(-0.4,-3.0,W) :- W is 2*pi/(18.1*12).
% yp(0.11,1.0).


mod_sin_period(0.0,N,M,_,0) :- N =< M.
mod_sin_period(Period,N,M,X,Y) :-
	 N =< M,diup(A,T,W), yp(AY,TY), test_period(N,Period,P), Y is sin(2*pi*X/P+A*sin(W*X+T)+AY*sin(W*X+TY)).
mod_sin_period(_,N,M,_,0.0) :- N > M.
% mod_sin_period(Period,N,M,X,Y) :- P is 1.0*Period, Y is sin(2*pi*X/P).

mod_cos_period(0.0,N,M,_,0) :- N =< M.
mod_cos_period(Period,N,M,X,Y) :-
	N =< M,diup(A,T,W), yp(AY,TY), test_period(N,Period,P), Y is cos(2*pi*X/P+A*sin(W*X+T)+AY*sin(W*X+TY)).
mod_cos_period(_,N,M,_,0.0) :- N > M.
% mod_cos_period(Period,N,M,X,Y) :- P is 1.0*Period, Y is cos(2*pi*X/P).

yearly_qmod(X,Y) :- Y is 1.0 - 0.0*cos(2*pi*X/12/2.3334+3.5).

%biamp(X,Amp) :- Amp is (1-0.2*cos(2*pi/(10.1*12)*X - 0.7)).
%bimod(X,Mod) :- Mod is 0.7*cos(2*pi/(17.9*12)*X + 0.9).
biamp(X,Amp) :- Amp is (1-0.21*cos(2*pi/(10.09*12)*X - 0.66)).
bimod(X,Mod) :- Mod is 0.68*cos(2*pi/(17.9*12)*X + 0.9).
% biamp(_,1.0).
% bimod(_,0.0).
% sin_biennial_period(X,Y) :- X > 76*12, bimod(X,M), biamp(X,A), Y is A*sin(2*pi*X/24+M), !.
%
sin_biennial_period(X,Y) :-  bimod(X,M), biamp(X,A), Y is -A*sin(2*pi*X/24+M).

%  cos_biennial_period(X,Y) :- X > 76*12, bimod(X,M), biamp(X,A), Y is A*cos(2*pi*X/24+M), !.
%
cos_biennial_period(X,Y) :-  bimod(X,M),  biamp(X,A), Y is -A*cos(2*pi*X/24+M+0.0).


yearly_mod(X,Y) :- Y is 1.0 + 0*0.15*cos(2*pi*X/12+0.4).

% mathieu_mod(X,Y) :- Y is 5.0*cos(2*pi*X/10.201+2.4).
% mathieu_mod(X,Y) :- Y is -0.6*(1.0+0*0.3*cos(2*pi*X/9.3+0.2)).
% mathieu_mod(X,Y) :- Y is -1.0*(1.0 +0.3*cos(2*pi*X/8.3-1.8)).
% mathieu_mod(X,Y) :- Y is -0.7*(1.0+1.0*cos(2*pi*X/2.0+2.6)).
%  mathieu_mod(X,Y) :- Y is
% -0.7*(1.0+0*0.9*cos(2*pi*X/10.6+4.4)*cos(2*pi*X/2.33-2.4)).
mathieu_mod(X,Y) :- Y is -0.7*(1.0-0*0.4*cos(2*pi*X/2.33-2.4)).

/*yearly_sin_period(0.0,N,M,_,0) :- N =< M.
yearly_sin_period(Period,N,M,X,Y) :- N =< M, test_period(N,Period,P), Y is sin(2*pi*X/P).
yearly_sin_period(_,N,M,_,0.0) :- N > M.
yearly_cos_period(0.0,N,M,_,0) :- N =< M.
yearly_cos_period(Period,N,M,X,Y) :- N =< M, test_period(N,Period,P), Y is cos(2*pi*X/P).
yearly_cos_period(_,N,M,_,0.0) :- N > M.
*/

qbo15([
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
10	,
-60	,
-100	,
-160	,
-210	,
-220	,
-240	,
-260	,
-260	,
-255	,
-250	,
-245	,
-240	,
-235	,
-230	,
-220	,
-210	,
-120	,
-40	,
60	,
110	,
130	,
155	,
160	,
155	,
160	,
165	,
170	,
155	,
140	,
120	,
75	,
5	,
70	,
-130	,
-220	,
-280	,
-283	,
-302	,
-280	,
-260	,
-280	,
-235	,
-120	,
15	,
50	,
135	,
115	,
38	,
60	,
85	,
175	,
130	,
23	,
2	,
-2	,
-5	,
-20	,
-70	,
-190	,
-210	,
-220	,
-202	,
-230	,
-247	,
-256	,
-235	,
-245	,
-265	,
-258	,
-124	,
-78	,
-54	,
2	,
26	,
92	,
152	,
189	,
281	,
197	,
130	,
112	,
50	,
-48	,
-74	,
-90	,
-110	,
-160	,
-180	,
-220	,
-247	,
-190	,
-18	,
88	,
146	,
116	,
110	,
110	,
150	,
177	,
199	,
174	,
143	,
69	,
19	,
-29	,
-122	,
-220	,
-246	,
-267	,
-297	,
-294	,
-307	,
-322	,
-322	,
-312	,
-323	,
-289	,
-236	,
-91	,
-165	,
-267	,
-206	,
-71	,
52	,
137	,
218	,
168	,
156	,
115	,
68	,
28	,
-60	,
-151	,
-111	,
-153	,
-236	,
-269	,
-275	,
-296	,
-330	,
-327	,
-337	,
-348	,
-336	,
-338	,
-338	,
-367	,
-353	,
-344	,
-336	,
-357	,
-379	,
-253	,
-10	,
18	,
72	,
70	,
133	,
119	,
150	,
165	,
149	,
116	,
108	,
34	,
7	,
-65	,
-90	,
-138	,
-180	,
-202	,
-225	,
-260	,
-305	,
-320	,
-333	,
-340	,
-325	,
-316	,
-325	,
-328	,
-330	,
-363	,
-261	,
-138	,
13	,
152	,
125	,
171	,
192	,
209	,
167	,
116	,
158	,
159	,
175	,
160	,
156	,
131	,
86	,
-13	,
-134	,
-184	,
-208	,
-224	,
-223	,
-229	,
-234	,
-252	,
-162	,
-101	,
-24	,
115	,
122	,
188	,
175	,
148	,
163	,
173	,
169	,
147	,
160	,
104	,
62	,
56	,
-61	,
-140	,
-203	,
-222	,
-271	,
-264	,
-276	,
-277	,
-285	,
-270	,
-250	,
-80	,
110	,
160	,
105	,
70	,
60	,
65	,
80	,
40	,
-20	,
-95	,
-160	,
-205	,
-230	,
-250	,
-275	,
-303	,
-335	,
-345	,
-335	,
-105	,
-315	,
-305	,
-240	,
-90	,
80	,
140	,
155	,
150	,
145	,
165	,
189	,
180	,
160	,
145	,
138	,
120	,
109	,
98	,
60	,
65	,
30	,
-100	,
-230	,
-260	,
-285	,
-275	,
-265	,
-257	,
-257	,
-256	,
-270	,
-285	,
-305	,
-260	,
-125	,
25	,
105	,
120	,
135	,
160	,
180	,
207	,
204	,
155	,
120	,
80	,
-85	,
-209	,
-235	,
-304	,
-314	,
-325	,
-272	,
-290	,
-324	,
-335	,
-342	,
-330	,
-320	,
-275	,
-220	,
-180	,
-114	,
30	,
98	,
102	,
126	,
106	,
116	,
147	,
175	,
173	,
100	,
60	,
25	,
20	,
-44	,
-75	,
-105	,
-131	,
-195	,
-250	,
-255	,
-232	,
-230	,
-235	,
-238	,
-252	,
-259	,
-248	,
-232	,
-239	,
-233	,
-168	,
-16	,
100	,
116	,
175	,
191	,
165	,
188	,
167	,
121	,
90	,
10	,
-54	,
-200	,
-278	,
-307	,
-320	,
-348	,
-341	,
-342	,
-356	,
-378	,
-355	,
-352	,
-353	,
-349	,
-179	,
-49	,
47	,
96	,
110	,
158	,
222	,
196	,
136	,
175	,
192	,
195	,
139	,
98	,
82	,
71	,
-15	,
-128	,
-242	,
-276	,
-237	,
-293	,
-322	,
-323	,
-330	,
-335	,
-355	,
-355	,
-344	,
-350	,
-364	,
-374	,
-356	,
-331	,
-350	,
-45	,
60	,
108	,
145	,
145	,
139	,
147	,
106	,
101	,
5	,
-158	,
-215	,
-281	,
-274	,
-309	,
-372	,
-373	,
-371	,
-334	,
-335	,
-353	,
-339	,
-359	,
-353	,
-347	,
-367	,
-346	,
-91	,
-76	,
12	,
73	,
218	,
173	,
192	,
212	,
181	,
120	,
130	,
82	,
108	,
129	,
103	,
14	,
-107	,
-159	,
-157	,
-193	,
-240	,
-260	,
-300	,
-310	,
-293	,
-278	,
-288	,
-235	,
-40	,
-33	,
-15	,
3	,
78	,
110	,
115	,
90	,
171	,
176	,
162	,
194	,
184	,
171	,
214	,
201	,
124	,
-158	,
-291	,
-316	,
-316	,
-326	,
-340	,
-344	,
-327	,
-315	,
-313	,
-334	,
-352	,
-364	,
-262	,
-38	,
72	,
144	,
143	,
178	,
199	,
183	,
79	,
63	,
107	,
36	,
-127	,
-195	,
-211	,
-209	,
-216	,
-195	,
-208	,
-267	,
-279	,
-286	,
-331	,
-369	,
-360	,
-318	,
-193	,
23	,
102	,
199	,
208	,
176	,
170	,
186	,
194	,
169	,
164	,
92	,
73	,
78	,
-20	,
-101	,
-132	,
-192	,
-250	,
-270	,
-306	,
-334	,
-342	,
-195	,
30	,
106	,
125	,
204	,
214	,
137	,
219	,
116	,
162	,
100	,
52	,
-5	,
-3	,
-23	,
-144	,
-204	,
-237	,
-270	,
-301	,
-337	,
-348	,
-361	,
-384	,
-374	,
-386	,
-387	,
-369	,
-381	,
-358	,
-327	,
-361	,
-358	,
-282	,
-46	,
21	,
89	,
77	,
97	,
132	,
162	,
224	,
210	,
199	,
229	,
147	,
103	,
2	,
-12	,
-21	,
7	,
-93	,
-175	,
-151	,
-203	,
-288	,
-335	,
-339	,
-332	,
-315	,
-75	,
53	,
87	,
92	,
158	,
242	,
225	,
143	,
170	,
147	,
132	,
107	,
94	,
31	,
-60	,
-137	,
-202	,
-246	,
-283	,
-308	,
-340	,
-341	,
-343	,
-356	,
-353	,
-362	,
-334	,
-76	,
106	,
195	,
165	,
152	,
166	,
94	,
132	,
132	,
114	,
62	,
73	,
-7	,
-139	,
-206	,
-266	,
-296	,
-317	,
-321	,
-320	,
-330	,
-329	,
-245	,
-70	,
42	,
115	,
192	,
171	,
170	,
181	,
145	,
102	,
123	,
92	,
41	,
34	,
-105	,
-189	,
-245	,
-251	,
-248	,
-260	,
-300	,
-330	,
-345	,
-371	,
-366	,
-369	,
-391	,
-373	,
-375	,
-362	,
-347	,
-332	,
-342	,
-236	,
59	,
140	,
150	,
153	,
140	,
147	,
39	,
-44	,
-13	,
-69	,
-208	,
-286	,
-325	,
-336	,
-370	,
-375	,
-358	,
-346	,
-320	,
-356	,
-348	,
-330	,
-333	,
-287	,
-44	,
27	,
83	,
88	,
102	,
133	,
202	,
173	,
169	,
194	,
158	,
132	,
151	,
121	,
122	,
148	,
116	,
77	,
-51	,
-75	,
-111	,
-167	,
-271	,
-288	,
-293	,
-304	,
-318	,
-319	,
-321	,
-329	,
-158	,
-92	,
58	,
82	,
87	,
110	,
125	,
159	,
165	,
207	,
121
]).

qbo30([
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
220	,
210	,
190	,
140	,
110	,
80	,
70	,
50	,
28	,
10	,
-15	,
-60	,
-110	,
-250	,
-200	,
-220	,
-235	,
-230	,
-245	,
-250	,
-185	,
-100	,
60	,
75	,
105	,
108	,
105	,
145	,
190	,
185	,
190	,
211	,
180	,
163	,
66	,
59	,
-22	,
-62	,
-112	,
-224	,
-222	,
-252	,
-249	,
-266	,
-282	,
-276	,
-246	,
-84	,
-21	,
-13	,
92	,
120	,
137	,
141	,
147	,
160	,
180	,
144	,
117	,
110	,
60	,
49	,
37	,
-63	,
-197	,
-204	,
-233	,
-257	,
-277	,
-304	,
-337	,
-330	,
-267	,
-258	,
-255	,
-217	,
-60	,
135	,
207	,
193	,
190	,
127	,
83	,
40	,
-2	,
-18	,
-46	,
-124	,
-182	,
-252	,
-260	,
-256	,
-255	,
-249	,
-208	,
-155	,
-13	,
29	,
38	,
114	,
142	,
181	,
140	,
126	,
89	,
98	,
125	,
69	,
55	,
69	,
49	,
-27	,
-161	,
-228	,
-252	,
-275	,
-280	,
-311	,
-302	,
-292	,
-282	,
-333	,
-346	,
-328	,
-317	,
-215	,
-15	,
36	,
85	,
65	,
70	,
70	,
35	,
-14	,
54	,
64	,
68	,
61	,
27	,
37	,
20	,
32	,
15	,
19	,
7	,
-12	,
-37	,
-157	,
-242	,
-268	,
-287	,
-291	,
-321	,
-319	,
-344	,
-329	,
-302	,
-207	,
-70	,
57	,
136	,
160	,
148	,
153	,
182	,
160	,
144	,
148	,
148	,
145	,
105	,
101	,
53	,
-60	,
-165	,
-150	,
-166	,
-159	,
-197	,
-249	,
-196	,
-208	,
-253	,
-258	,
-232	,
-265	,
-314	,
-308	,
-319	,
-313	,
-207	,
-138	,
4	,
61	,
104	,
151	,
151	,
140	,
151	,
138	,
104	,
88	,
3	,
-54	,
-96	,
-147	,
-166	,
-229	,
-258	,
-294	,
-290	,
-306	,
-327	,
-329	,
-312	,
-189	,
-32	,
45	,
102	,
118	,
132	,
135	,
200	,
160	,
122	,
134	,
125	,
112	,
95	,
74	,
83	,
40	,
-187	,
-231	,
-246	,
-250	,
-273	,
-269	,
-284	,
-172	,
58	,
117	,
106	,
104	,
138	,
132	,
103	,
98	,
85	,
85	,
45	,
10	,
-14	,
-29	,
-31	,
-129	,
-225	,
-289	,
-282	,
-304	,
-298	,
-288	,
-292	,
-300	,
-305	,
-240	,
-85	,
50	,
93	,
171	,
170	,
153	,
152	,
145	,
150	,
157	,
129	,
124	,
123	,
99	,
30	,
-146	,
-220	,
-248	,
-205	,
-257	,
-230	,
-257	,
-270	,
-268	,
-275	,
-285	,
-280	,
-266	,
-140	,
-91	,
44	,
88	,
120	,
170	,
185	,
149	,
128	,
114	,
115	,
100	,
85	,
75	,
93	,
55	,
48	,
20	,
37	,
65	,
-75	,
-147	,
-236	,
-256	,
-264	,
-284	,
-274	,
-280	,
-271	,
-155	,
27	,
34	,
94	,
117	,
124	,
153	,
159	,
151	,
131	,
125	,
107	,
111	,
101	,
91	,
79	,
60	,
-136	,
-241	,
-269	,
-278	,
-281	,
-295	,
-289	,
-302	,
-302	,
-310	,
-316	,
-310	,
-291	,
-283	,
-145	,
72	,
119	,
137	,
117	,
164	,
157	,
151	,
134	,
128	,
108	,
-60	,
-152	,
-177	,
-199	,
-203	,
-252	,
-255	,
-275	,
-283	,
-283	,
-288	,
-321	,
-346	,
-354	,
-340	,
-335	,
-281	,
-22	,
65	,
110	,
87	,
141	,
137	,
139	,
115	,
100	,
85	,
93	,
100	,
102	,
119	,
152	,
148	,
142	,
106	,
-42	,
-194	,
-232	,
-229	,
-234	,
-241	,
-254	,
-267	,
-260	,
-266	,
-271	,
-270	,
-268	,
-247	,
-63	,
92	,
138	,
117	,
77	,
57	,
54	,
46	,
78	,
70	,
50	,
-23	,
-102	,
-63	,
-50	,
-81	,
-101	,
-99	,
-84	,
-40	,
-38	,
-150	,
-250	,
-281	,
-306	,
-300	,
-310	,
-307	,
-306	,
-282	,
-42	,
-32	,
109	,
124	,
124	,
152	,
131	,
135	,
130	,
109	,
110	,
134	,
114	,
127	,
105	,
92	,
-67	,
-209	,
-250	,
-231	,
-215	,
-222	,
-242	,
-253	,
-253	,
-254	,
-260	,
-262	,
-275	,
-268	,
-79	,
8	,
75	,
112	,
141	,
176	,
155	,
164	,
170	,
112	,
108	,
48	,
-10	,
-8	,
-44	,
-111	,
-205	,
-240	,
-251	,
-265	,
-291	,
-298	,
-318	,
-328	,
-338	,
-336	,
-271	,
-9	,
109	,
167	,
178	,
115	,
86	,
110	,
155	,
151	,
125	,
72	,
34	,
-32	,
-131	,
-169	,
-183	,
-202	,
-239	,
-277	,
-307	,
-330	,
-325	,
-346	,
-355	,
-349	,
-284	,
-56	,
22	,
100	,
106	,
151	,
151	,
167	,
141	,
114	,
97	,
75	,
15	,
-49	,
-50	,
-57	,
-127	,
-253	,
-280	,
-297	,
-308	,
-321	,
-311	,
-292	,
-68	,
70	,
99	,
131	,
98	,
140	,
126	,
137	,
111	,
110	,
101	,
91	,
47	,
61	,
74	,
95	,
113	,
61	,
-71	,
-227	,
-282	,
-294	,
-288	,
-275	,
-253	,
-259	,
-284	,
-272	,
-269	,
-309	,
-318	,
-331	,
-349	,
-354	,
-307	,
-136	,
21	,
140	,
118	,
148	,
158	,
129	,
133	,
92	,
103	,
83	,
65	,
41	,
-42	,
-41	,
-14	,
-2	,
-73	,
-194	,
-269	,
-288	,
-313	,
-318	,
-313	,
-312	,
-321	,
-165	,
-16	,
78	,
112	,
126	,
120	,
95	,
90	,
98	,
88	,
73	,
48	,
14	,
-18	,
18	,
-9	,
-178	,
-266	,
-286	,
-309	,
-316	,
-318	,
-320	,
-333	,
-324	,
-288	,
-93	,
83	,
85	,
106	,
123	,
126	,
71	,
109	,
93	,
89	,
73	,
54	,
53	,
14	,
-147	,
-253	,
-297	,
-313	,
-316	,
-321	,
-316	,
-320	,
-265	,
-126	,
38	,
112	,
124	,
124	,
157	,
135	,
118	,
105	,
93	,
75	,
111	,
119	,
155	,
118	,
103	,
32	,
-134	,
-227	,
-218	,
-220	,
-199	,
-252	,
-259	,
-265	,
-272	,
-269	,
-271	,
-263	,
-285	,
-59	,
117	,
134	,
116	,
118	,
83	,
97	,
97	,
101	,
92	,
96	,
70	,
9	,
25	,
-32	,
-75	,
-189	,
-239	,
-238	,
-213	,
-217	,
-257	,
-306	,
-325	,
-326	,
-347	,
-331	,
-336	,
-335	,
-161	,
-47	,
18	,
89	,
102	,
109	,
157	,
147	,
122	,
139	,
119	,
118	,
117	,
148	,
126	,
113	,
88	,
-131	,
-258	,
-307	,
-295	,
-317	,
-323	,
-312	,
-287	,
-278	,
-295	,
-314	,
-311	,
-140	,
75	,
129	,
135	,
162	,
132
]).

qbo70([
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,
-60	,
-2	,
50	,
75	,
95	,
135	,
110	,
75	,
22	,
70	,
125	,
115	,
50	,
1	,
45	,
55	,
60	,
55	,
40	,
25	,
-20	,
-55	,
-80	,
-90	,
-40	,
20	,
55	,
50	,
50	,
45	,
20	,
38	,
70	,
125	,
155	,
110	,
38	,
65	,
90	,
152	,
152	,
95	,
25	,
-8	,
-42	,
-15	,
-5	,
-60	,
-65	,
-75	,
-75	,
-60	,
-50	,
-30	,
-20	,
-5	,
15	,
40	,
40	,
25	,
25	,
20	,
30	,
70	,
85	,
90	,
85	,
80	,
70	,
50	,
30	,
25	,
15	,
-18	,
-45	,
-60	,
-60	,
-65	,
-70	,
-65	,
-20	,
45	,
70	,
75	,
65	,
20	,
50	,
65	,
80	,
85	,
-2	,
-20	,
-40	,
-40	,
-50	,
-95	,
-119	,
-100	,
-92	,
-66	,
-69	,
8	,
43	,
23	,
15	,
27	,
62	,
31	,
54	,
36	,
70	,
101	,
178	,
135	,
133	,
82	,
62	,
80	,
90	,
76	,
19	,
11	,
-11	,
14	,
-32	,
-70	,
-136	,
-177	,
-168	,
-78	,
-4	,
29	,
10	,
0	,
33	,
21	,
63	,
89	,
123	,
88	,
73	,
83	,
109	,
47	,
31	,
60	,
91	,
59	,
147	,
175	,
139	,
90	,
86	,
57	,
-12	,
-82	,
-116	,
-85	,
-70	,
-82	,
-98	,
-85	,
-25	,
-10	,
8	,
82	,
52	,
79	,
83	,
63	,
27	,
91	,
155	,
156	,
153	,
116	,
98	,
87	,
71	,
79	,
35	,
78	,
52	,
47	,
83	,
87	,
73	,
33	,
13	,
34	,
24	,
-10	,
-32	,
-50	,
-71	,
-84	,
-59	,
6	,
89	,
84	,
86	,
95	,
83	,
68	,
69	,
5	,
48	,
22	,
65	,
87	,
74	,
40	,
46	,
9	,
-2	,
-30	,
-42	,
-56	,
-77	,
-78	,
-106	,
-12	,
54	,
60	,
-15	,
14	,
40	,
74	,
50	,
67	,
96	,
116	,
104	,
132	,
90	,
52	,
-4	,
-14	,
-45	,
-114	,
-82	,
-74	,
-115	,
-109	,
-17	,
65	,
69	,
65	,
74	,
84	,
89	,
72	,
64	,
39	,
73	,
79	,
88	,
111	,
101	,
92	,
63	,
32	,
7	,
-39	,
-22	,
-73	,
-76	,
-73	,
-90	,
-78	,
-88	,
-53	,
-19	,
50	,
71	,
37	,
24	,
33	,
51	,
73	,
92	,
85	,
73	,
80	,
62	,
64	,
61	,
40	,
55	,
39	,
30	,
28	,
30	,
-27	,
-80	,
-102	,
-77	,
-78	,
-99	,
-92	,
-48	,
-8	,
4	,
55	,
61	,
69	,
58	,
67	,
68	,
69	,
69	,
68	,
21	,
38	,
44	,
54	,
108	,
107	,
55	,
44	,
17	,
-5	,
-32	,
-99	,
-55	,
-48	,
-82	,
-83	,
-102	,
-92	,
5	,
17	,
30	,
71	,
60	,
50	,
25	,
31	,
54	,
75	,
82	,
96	,
98	,
78	,
64	,
71	,
76	,
39	,
25	,
16	,
36	,
48	,
-57	,
-102	,
-137	,
-133	,
-131	,
-113	,
-80	,
9	,
14	,
24	,
-6	,
8	,
91	,
84	,
77	,
82	,
71	,
73	,
71	,
56	,
45	,
32	,
40	,
49	,
65	,
52	,
-6	,
-45	,
-71	,
-66	,
-73	,
-73	,
-72	,
-67	,
-96	,
-68	,
-6	,
-15	,
46	,
42	,
57	,
68	,
53	,
15	,
21	,
37	,
61	,
53	,
94	,
102	,
86	,
50	,
64	,
95	,
78	,
43	,
57	,
61	,
22	,
-4	,
-2	,
-74	,
-145	,
-148	,
-133	,
-115	,
-37	,
-2	,
7	,
49	,
20	,
19	,
22	,
61	,
60	,
57	,
53	,
54	,
58	,
23	,
68	,
37	,
41	,
67	,
77	,
58	,
42	,
36	,
41	,
3	,
-20	,
3	,
-14	,
-81	,
-31	,
-81	,
-109	,
-50	,
12	,
19	,
32	,
60	,
76	,
56	,
26	,
63	,
52	,
57	,
79	,
71	,
52	,
24	,
34	,
38	,
27	,
36	,
-5	,
47	,
-11	,
26	,
12	,
-32	,
-76	,
-100	,
-90	,
-96	,
-112	,
-105	,
-24	,
-23	,
21	,
55	,
88	,
95	,
57	,
43	,
32	,
71	,
92	,
67	,
51	,
47	,
92	,
83	,
86	,
-14	,
-72	,
-95	,
-120	,
-96	,
-110	,
-70	,
-15	,
-6	,
-40	,
-25	,
41	,
35	,
86	,
87	,
65	,
68	,
47	,
58	,
58	,
65	,
44	,
62	,
71	,
63	,
19	,
-24	,
-23	,
-32	,
-72	,
-31	,
-59	,
-5	,
-87	,
-54	,
-76	,
-24	,
90	,
90	,
95	,
73	,
63	,
33	,
20	,
39	,
29	,
96	,
68	,
30	,
8	,
-12	,
-35	,
-30	,
-87	,
-71	,
-65	,
-78	,
-57	,
-39	,
13	,
44	,
50	,
32	,
35	,
40	,
42	,
32	,
62	,
48	,
46	,
60	,
92	,
106	,
92	,
88	,
76	,
62	,
35	,
-6	,
7	,
22	,
-30	,
17	,
42	,
55	,
-4	,
-54	,
-31	,
-50	,
-39	,
-62	,
-47	,
-62	,
-87	,
9	,
35	,
33	,
10	,
42	,
58	,
88	,
52	,
30	,
31	,
42	,
47	,
19	,
59	,
55	,
40	,
31	,
27	,
34	,
4	,
-9	,
-62	,
-36	,
-58	,
-77	,
-26	,
43	,
39	,
34	,
34	,
65	,
37	,
62	,
4	,
24	,
78	,
29	,
73	,
50	,
44	,
45	,
0	,
-3	,
-16	,
8	,
-14	,
-63	,
-31	,
-72	,
-125	,
-110	,
-24	,
8	,
68	,
76	,
62	,
81	,
41	,
34	,
55	,
91	,
99	,
79	,
21	,
-8	,
12	,
28	,
4	,
-30	,
-65	,
-5	,
-21	,
-49	,
-114	,
-47	,
47	,
35	,
16	,
40	,
23	,
-14	,
-10	,
44	,
36	,
67	,
91	,
95	,
82	,
58	,
69	,
94	,
66	,
64	,
82	,
61	,
49	,
56	,
-56	,
-137	,
-163	,
-163	,
-185	,
-37	,
41	,
44	,
6	,
62	,
48	,
7	,
56	,
33	,
76	,
67	,
109	,
108	,
100	,
54	,
7	,
-1	,
10	,
-7	,
16	,
54	,
12	,
22	,
29	,
37	,
11	,
26	,
-2	,
-1	,
-60	,
-54	,
-128	,
-113	,
-18	,
11	,
60      ,  %
  66    ,
  82	,
  74	,
  62	,
  49	,
  25	,
  82	,
  97	,
  110	,
  110	,
  84	,
  109, 62, 84, 33, -7, 5, -9, -29, -123, -127, -158, -134, -20, 70

]).

temp_data('QBO70', qbo70).
temp_data('QBO30', qbo30).
temp_data('QBO15', qbo15).
temp_data('QBO other', qbo).
temp_data('SOI', soi).
temp_data('Darwin-Tahiti', dt).
temp_data('Tides', sydney).
temp_data('Tides Filtered', sydney2).
temp_data('Tides Biennial Flip', sydney_flip).
temp_data('nino3', nino3).
temp_data('NAO', nao).
temp_data('AMO', amo).
temp_data('GISS', giss).
temp_data('HADCRUT4', hadcrut).
temp_data('BESTLand', best).
temp_data('BEST', best_land_ocean).
temp_data('BEST ER', bester).
temp_data('GISS+HADCRUT4_CW+NOAA', global_combo).
temp_data('HADSST3', sst).
temp_data('CRUTEM4', land).
temp_data('GISSLand', gistemp_dts).
temp_data('BEST+CRUTEM4+GISSLand', land_combo).
temp_data('GISS+NRDC+NOAA', global_combo2).
temp_data('CRUTEM+2*HADSST', composed).
temp_data('NOAA LAND OCEAN', noaa_land_ocean).
temp_data('NOAA LAND', noaa_land).
temp_data('NOAA OCEAN', noaa_ocean).
temp_data('HADCRUT3', hadcrut3).
temp_data('HADSST2', sst2).
temp_data('NCDC', ncdc).
temp_data('HADCRUT4_CW', hadcrut4_cw).
temp_data('OU Random Walk', ou_rw).
temp_data('ER SST', er).

orbital_period('tide precession',  7.3,   'spring tides to realign with calendar date').
orbital_period('tidal cycle',      9.015, 'sun-moon-earth configuration induced oscillation').
orbital_period('lunar standstill', 18.6,  'nodal period when declination of the moon reaches max, Kola cycle').
orbital_period('lunar absidal',    8.85,  'when sidereal period exceeds anomalistic period by one month').
orbital_period('jupiter sidereal', 11.86, 'tidal sidereal period of jupiter').
orbital_period('tidal saros',      18.03, 'Saros cycle period of eclipses of the sun and moon').
orbital_period('lunar harmonic',   6.2,   'one third of the lunar standstill, Kola cycle').
orbital_period('absidal harmonic', 4.42,    'one half lunar absidal').
orbital_period('jupiter harmonic', 5.93,    'one half jupiter sidereal').
% extra

dataset(ou_rw, RW) :-
    qbo30(L),
    length(L, N),
    Range range [1,N]/1,
    % PL mapdot fake_power_law(1650.0,3) ~> Range,
    context_random_walk:ou_random_walker(0.005,1,0.1,Range,RW), !.
    % L mapdot PL + RW, !.

dataset(giss, L) :- giss(L).
dataset(hadcrut4_cw, L) :-
        hadcrut(L0),
        hadcrut_cw(W),
        Front1 range 1*[1,1188],
        Front0 range 0*[1,1188],
        Change range 0*[1,417],
        % Back1 range 1*[1,5],
        % Back0 range 0*[1,5],
        Mask cat [Front1,Change],
        W_Offset mapdot 0.296 .+ W,
        CW cat [Front0, W_Offset],
        M mapdot Mask * L0,
        L mapdot M + CW.

dataset(hadcrut, L) :- hadcrut(L).
dataset(best, L) :- best(L). %best_land_update(L). %  best(L).
dataset(best_land_ocean, L) :- best_land_ocean(L).
dataset(sst, L) :- sst(L).
dataset(land, L) :- land(L).
dataset(gistemp_dts, L) :- gistemp_dts(L).
dataset(global_combo, L) :-
	dataset(giss,L1),
	dataset(hadcrut4_cw,L2),
	dataset(noaa_land_ocean,L3),
	L mapdot 0.3333 .* L1 + 0.3333 .* L2 + 0.3333 .* L3.
dataset(global_combo2, L) :-
	dataset(giss,L1),
	dataset(ncdc,L2),
	dataset(noaa_land_ocean,L3),
	L mapdot 0.3333 .* L1 + 0.3333 .* L2 + 0.3333 .* L3.
dataset(er, L) :-
	er_sst(L).
dataset(bester, L) :-
	% er_sst(L1),
	dataset(noaa_ocean, L1),
	dataset(best,L2),
	L mapdot 0.72 .* L1 + 0.28 .* L2.

dataset(land_combo, L) :-
	dataset(land,L1),
	dataset(best,L2),
        dataset(gistemp_dts,L3),
	L mapdot 0.3333 .* L1 + 0.3333 .* L2 + 0.3333 .* L3.
dataset(composed, L) :-
	dataset(land,L1),
	dataset(sst,L2),
	L mapdot 0.3 .* L1  +  1.4 .* L2.
dataset(noaa_land_ocean, L) :- noa_land_ocean(L).
dataset(noaa_land, L) :- noa_land(L).
dataset(noaa_ocean, L) :- noa_ocean(L).
dataset(sst2, L) :- hadsst2(L).
dataset(hadcrut3, L) :- hadcrut3(L).
dataset(ncdc, L) :- ncdc(L).
dataset(soi, L) :-
        soi(L0),
	%L1 mapdot abs ~> L0,
	%L2 mapdot sign ~> L0,
	%L3 mapdot sqrt ~> L1,
	%L4 mapdot L2 * L3,
	L unbias L0.
dataset(dt, L) :-
        darwin(D),
        tahiti(T),
	L0 mapdot 0.75 .* D -T,
	% L1 mapdot abs ~> L0,
	% L2 mapdot sign ~> L0,
	% L3 mapdot sqrt ~> L1,
	% L4 mapdot L2 * L3,
	L unbias L0.

add_not_zero(_,[],Initial,Final) :-
   reverse(Initial, Final).
add_not_zero(A,[0|ZR],Initial,Final) :-
   add_not_zero(A,ZR,[0|Initial],Final).
add_not_zero(A,[ZF|ZR],Initial,Final) :-
   Value is A+ZF,
   add_not_zero(A,ZR,[Value|Initial],Final).

list_length(Xs,L) :- list_length(Xs,0,L) .

list_length( []     , L , L ) .
list_length( [0|Xs] , T , L ) :-
  list_length(Xs,T,L).
list_length( [_|Xs] , T , L ) :-
  T1 is T+1 ,
  list_length(Xs,T1,L).

unbias_series(Y, R) :-
   sumlist(Y,N),
   list_length(Y,L),
   Offset is -N/L,
   add_not_zero(Offset, Y, [], R), !.


dataset(qbo15, L) :-
        qbo15(L0),
	L unbias L0.
dataset(qbo30, L) :-
        qbo30(L).
	%      unbias_series(L0,L1),
	%      L accumulate L1.
	%L1 mapdot abs ~> L0,
	%L2 mapdot sign ~> L1,
	%L3 mapdot sqrt ~> L2,
	%L mapdot L0 - 200 .* L3.
	% L unbias L0.
dataset(qbo70, L) :-
        qbo70(L0),
	% L1 mapdot abs ~> L0,
	% L2 mapdot sign ~> L0,
	% L3 mapdot sqrt ~> L1,
	%L4 mapdot L2 * L3,
	L unbias L0.
dataset(qbo, L) :-
        qbo(L0),
	L unbias L0.

dataset(sydney, L) :-
	sydney_tides2(L0),
	L1 unbias L0,
        F window L1*134,
        L mapdot L1 - F.

dataset(sydney2, L) :-
	sydney_tides2(L0),
	L1 unbias L0,
        F window L1*32,
        L mapdot L1 - F.

dataset(sydney_flip, L) :-
	sydney_tides2(L0),
	L1 unbias L0,
        F window L1*32,
        L2 mapdot L1 - F,
        Front range -1*[1,912],
        Back range 1*[913,1607],
        Mask cat [Front,Back],
	L mapdot L2 * Mask.


dataset(nino3, L) :-
        nino3(L0),
	L unbias L0.

dataset(nao, L) :-
        nao(L0),
	L unbias L0.

dataset(amo, L) :-
        amo(L0),
        F window L0*240,
        L1 mapdot L0 - F,
	L unbias L1.


navigate(Request) :-
   collect_unit_options(calendar, Calendar),
   con_text:collect_options(context_qbo:temp_data, DataSet),
   findall([N,D,P], orbital_period(N,P,D), CycleData),

   reply_html_page(cliopatria(default),
                   [title('QBO model response'),
		    script([type('text/javascript'),src('/html/js/submit.js')], [])
		    % , \(con_text:style)
		   ],
                   [\(con_text:table_with_iframe_target(
                                    Request,
		     [
                      h1('QBO Model'),
                      form([action(plot), target(target_iframe)],
			 [
                           p(['Select data set and a profile view ',
			      input([type('text'),
				 size(4),
				 name('startYear'),
				 value('1953')]),
			      ' : ',
			      input([type('text'),
				 size(4),
				 name('fitYear'),
				 value('2013')])
			     ]),

			  select([name('dataset')], DataSet),
			  % \(con_text:check_box(anthro, 'true', 'anthro aerosols')),
			  % \(con_text:check_box(volc, 'true', 'GISS aerosol model')),
			  input([type('text'),
				 size(2),
				 name('boost'),
				 value('1.0')]),  i(' scale'),
			  \(con_text:check_box(long, 'true', 'ENSO')),

			  br([]),
			  \(con_text:radio_toggles(
					 'evaluate',
					 [
					  ['Match index with model', model],
                                          ['Signal (not used)', signal],
					  ['View the residual error', residual],
					  ['View staggered fluctuation components', all],
					  ['Correlate (not used)', correlate],
					  ['Correlate index with model', map],
					  ['Match natural variability', fluctuation],
					  ['View composite cycles', cycles],
					  ['Dump all component factors', cross]
					  % , ['Cross-Correlate distance vs speed orbital modes ', cross],
					  % ['Show Arctic detrend (arctic_window > 0)', arctic]
                                         ])),
                          br([]),
			  input([type('submit'), name(kind), value('graph'),
                                  onclick('subm(this.form,"target_iframe");')]),
			  input([type('submit'), name(kind), value('table'),
                                  onclick('subm(this.form,"target_iframe");')]),
			  \(con_text:check_box(eq, 'true', 'CC entire range')),
			  \(con_text:check_box(sign, 'true', 'sign metric')),
			  br([]),
                          \(con_text:check_box(second_derivative, 'true', 'Second Deriv')),
			  \(con_text:check_box(fft, 'true', 'FFT of residual')),
			  br([]),
			  \(con_text:check_box(window, 'true', 'Apply 4 month window')),
			  \(con_text:check_box(triple, 'true', 'Pratt filter')),
			  % \(con_text:check_box(lunar, 'true', 'lunar')),

			  br([]),
			  input([type('text'),
				 size(2),
				 name('lag'),
				 value('0')]),
			  select([name('t_units')], Calendar),
			  small(i(' <= lag filter on Match')),

			  small(\multi_columns([
				     div([
					 style([ type('text/css'), scoped ],
					       '@import url("/html/css/context.css")'),
					 table(  %%%%%%%%%%%%%%%  Hard coded  values
				       [
					h2([i('lunar periods'),
					   img([src('/html/images/magnify-clip.png'),
						title('nominal values')
					       ])]),

					\(con_text:input_cells([[days,365.242181,6],
						      [drac,27.21222081,6],
						      [trop,27.32158224,6],
						      [anom,27.554549878,6],
						      [evec,31.8119,6],
                                                      [mfpr,27.266,6],
                                                      [syno,29.53058885,6]
                                                      % [amo_win,-120,2],
						      % [arctic_win, -120,2]
						     ]))
				       ]
					)]),
				     p([' ...... ']),
				     div([style([ type('text/css'), scoped ],
					 '@import url("/html/css/context.css")'),
					  i('number of factors'), br([]),
					  input([type('text'), size(2), name('wave'), value('18')]),
					  \(con_text:check_box(fit_res, 1, 'Mathieu mod')),
					  \(con_text:check_box(high_res, 1, 'high res', checked))
				%	  \(con_text:table_multiple_entries(
				%		  [[cycle, 'period description', year]],
				%		  CycleData
				%				    ))
				 ])
					 ]))
			 ]
			  ),
		      br([]),
		      \(con_text:render_iframe(render))
		     ]
						       ))
		   ]
		  ).

% check_for_nan('$NAN', 0.0) :- !.
% check_for_nan(V, V).


get_fit(StartDate, EndDate, [Temperature, CO2, SOI,  Volc,   LOD,  TSI, AAM,   Arctic, NAO, Sin, Cos,
	                                                          S2,  C2,
	                                                          S3,  C3,
	                                                          S4,  C4,
	                                                          S5,  C5,
	                                                          S6,  C6,
	                                                          S7,  C7,
	                                                          S8,  C8,
	                                                          S9,  C9,
	                                                          SA,  CA,
	                                                          SB,  CB,
	                                                          SC,  CC,
	                                                          SD,  CD,
	                                                          SE,  CE,
	                                                          SF,  CF

								  ],
	[             C,   S,   A,    L,  T, M, Z, N, V, W, P, Q,
		                                E, F, G, H, D, I, R, U,
		                                A1, B1, C1, D1, E1, F1,
		                                G1, H1, I1, J1, K1, L1,
		                                M1, N1, O1, P1, Q1, R1], Int, R2) :-
   % r_open_session,
   y <- Temperature,
   c <- CO2,
   s <- SOI,
   a <- Volc,
   l <- LOD,
   t <- TSI,
   m <- AAM,
   msS <- Arctic,
   msC <- NAO,
   c7S <- Sin,
   c7C <- Cos,
   s9S <- S2,
   s9C <- C2,
   diS <- S3,
   diC <- C3,
   q4S <- S4,
   q4C <- C4,
   qmS <- S5,
   qmC <- C5,
   q1S <- S6,
   q1C <- C6,
   c5S <- S7,
   c5C <- C7,
   cwS <- S8,
   cwC <- C8,
   sdS <- S9,
   sdC <- C9,
   qsS <- SA,
   qsC <- CA,
   spS <- SB,
   spC <- CB,
   q2S <- SC,
   q2C <- CC,
   clS <- SD,
   clC <- CD,
   q3S <- SE,
   q3C <- CE,
   qbS <- SF,
   qbC <- CF,
   % pccr <- princomp('~y+c+s+a+l+t+m+z+j+k+n+v+w+p+q+e+f+g+h+d+i+r+u+a1+b1+c1+d1+e1+f1+g1+h1+i1+j1+k1+l1+m1+n1+o1+p1+q1+r1+s1+t1+u1+v1+w1+x1'),
   % r_print(summary(pccr)),
   % Test <- 'as.double(pccr$coefficients[1])',
   % print(user_error, Test),
   % r_print(loadings(pccr)),
   B is (EndDate - 1880)*12,
   O is (StartDate - 1880)*12 + 1,
   % O = 1, % 840,
   format(atom(Eq), 'y[~d:~d]~~c[~d:~d]+s[~d:~d]+a[~d:~d]+l[~d:~d]+t[~d:~d]+m[~d:~d]+msS[~d:~d]+msC[~d:~d]+c7S[~d:~d]+c7C[~d:~d]+s9S[~d:~d]+s9C[~d:~d]+diS[~d:~d]+diC[~d:~d]+q4S[~d:~d]+q4C[~d:~d]+qmS[~d:~d]+qmC[~d:~d]+q1S[~d:~d]+q1C[~d:~d]+c5S[~d:~d]+c5C[~d:~d]+cwS[~d:~d]+cwC[~d:~d]+sdS[~d:~d]+sdC[~d:~d]+qsS[~d:~d]+qsC[~d:~d]+spS[~d:~d]+spC[~d:~d]+q2S[~d:~d]+q2C[~d:~d]+clS[~d:~d]+clC[~d:~d]+q3S[~d:~d]+q3C[~d:~d]+qbS[~d:~d]+qbC[~d:~d]',
	  [O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,
	   O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,
	   O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,
	   O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,O,B,
	   O,B,O,B,O,B,O,B,O,B]),
   fitxy <- lm(Eq),


   %   Add the variables here !!! don't forget
   % r_print(fitxy),
   Int <- 'as.double(fitxy$coefficients[1])',
   C <- 'as.double(fitxy$coefficients[2])',
   S <- 'as.double(fitxy$coefficients[3])',
   A <- 'as.double(fitxy$coefficients[4])',
   L <- 'as.double(fitxy$coefficients[5])',
   T <- 'as.double(fitxy$coefficients[6])',
   M <- 'as.double(fitxy$coefficients[7])',
   Z <- 'as.double(fitxy$coefficients[8])',
   N <- 'as.double(fitxy$coefficients[9])',
   V <- 'as.double(fitxy$coefficients[10])',
   W <- 'as.double(fitxy$coefficients[11])',
   P <- 'as.double(fitxy$coefficients[12])',
   Q <- 'as.double(fitxy$coefficients[13])',
   E <- 'as.double(fitxy$coefficients[14])',
   F <- 'as.double(fitxy$coefficients[15])',
   G <- 'as.double(fitxy$coefficients[16])',
   H <- 'as.double(fitxy$coefficients[17])',
   D <- 'as.double(fitxy$coefficients[18])',
   I <- 'as.double(fitxy$coefficients[19])',
   R <- 'as.double(fitxy$coefficients[20])',
   U <- 'as.double(fitxy$coefficients[21])',
   A1 <- 'as.double(fitxy$coefficients[22])',
   B1 <- 'as.double(fitxy$coefficients[23])',
   C1  <- 'as.double(fitxy$coefficients[24])',
   D1 <- 'as.double(fitxy$coefficients[25])',
   E1 <- 'as.double(fitxy$coefficients[26])',
   F1 <- 'as.double(fitxy$coefficients[27])',
   G1 <- 'as.double(fitxy$coefficients[28])',
   H1 <- 'as.double(fitxy$coefficients[29])',
   I1 <- 'as.double(fitxy$coefficients[30])',
   J1 <- 'as.double(fitxy$coefficients[31])',
   K1 <- 'as.double(fitxy$coefficients[32])',
   L1 <- 'as.double(fitxy$coefficients[33])',
   M1 <- 'as.double(fitxy$coefficients[34])',
   N1 <- 'as.double(fitxy$coefficients[35])',
   O1 <- 'as.double(fitxy$coefficients[36])',
   P1 <- 'as.double(fitxy$coefficients[37])',
   Q1 <- 'as.double(fitxy$coefficients[38])',
   R1 <- 'as.double(fitxy$coefficients[39])',
/*
   S1 <- 'as.double(fitxy$coefficients[40])',
   T1 <- 'as.double(fitxy$coefficients[41])',
   U1 <- 'as.double(fitxy$coefficients[42])',
   V1 <- 'as.double(fitxy$coefficients[43])',
   W1 <- 'as.double(fitxy$coefficients[44])',
   X1 <- 'as.double(fitxy$coefficients[45])',
   J <- 'as.double(fitxy$coefficients[46])',
   K <- 'as.double(fitxy$coefficients[47])',
   DY <- 'as.double(fitxy$coefficients[48])',
   LM <- 'as.double(fitxy$coefficients[49])',
*/
   summary <- summary(fitxy),
   % r_print(summary),
   R2 <- 'as.double(summary$r.squared)',
   % r_close,
   !.


% scale(_, lin, cross, 'factor a', '#', 'factor b', '#', false) :- !.
scale(_, lin, map, 'Model Temperature', 'C', 'Real Temperature', 'C', false) :- !.
scale(_, lin, correlate, 'TCR*ln(CO2)/ln(2)', 'C', 'Temperature', 'C', false) :- !.
scale(true, log, residual, 'Wavenumber', '2048/Month', 'Power Spectral', 'density', false) :- !.
scale(_, lin, model, 'Time', 'year', 'Index', '#', false) :- !.
scale(_, lin, _, 'Time', 'year', 'Temperature', 'C', false).

single_filter(In, Out) :-
    median_filter(In, In0),
    Out window In0*3.
triple_filter(In, Out) :-
    %median_filter(In, In0),
    % A window In*7, %7 13
    A=In,
    B window A*5, %5 9
    Out window B*3. %3 7

/*
triple_filter(In, Out) :-
    % median_filter(In, In0),
    A window In*7, %7 13
    B window A*5, %5 9
    Out window B*3. %3 7
*/
/*
triple_filter(In, Out) :-
    % median_filter(In, In0),
    A window In*7, %7 13
    B window A*5, %5 9
    Out window B*3. %3 7
*/

% temperature_series(true, true, DataSet, T) :-
%     dataset(DataSet, T0),
%    triple_filter(T0, T1),
%    T window T1*12.
temperature_series(_, true, DataSet, T) :-
    dataset(DataSet, T0),
    triple_filter(T0, T).
temperature_series(true, false, DataSet, T) :-
    dataset(DataSet, T0),
    single_filter(T0, T).
%    uniform(12,Win),
%    T window T0*Win.
temperature_series(false, false, DataSet, T) :-
    dataset(DataSet, T).
    % median_filter(T0, T).

/*
temperature_series(true, DataSet, T) :-
    dataset(DataSet, T0),
    uniform(12,Win),
    T window T0*Win.
temperature_series(false, DataSet, T) :-
    dataset(DataSet, T).
*/

get_fit(1, -1.0).
get_fit(0, 1.0).

% mathieu_modulate(X,Y) :- Y is 1.0-0.5*cos(2*pi*X/17.56-3.0).
mathieu_modulater(Z,X,Y) :- Y is 1.0+Z*0.39*cos(2*pi*X/2.369715-1.23).
% mathieu_modulater(Z,X,Y) :- Y is
% 1.0+0.4*cos(2*pi*X/6.51-2.0)+0.7*cos(2*pi*X/9.07-1.8).

temperature_series(Second, Window, Triple, DataSet, T, Fit, Offset) :-
   temperature_series(Window, Triple, DataSet, TTT),
   temperature_series(Window, true, DataSet, TD3),
   get_fit(Fit, Flip),
   get_years_from_1880(TTT, Year, _),
   length(Year,L),
   TT1 derivative TTT / Year,
   TT2 derivative TT1 / Year,
   % median_filter(TT2a,TT2),
   % TT2 derivative TTT / Year,
   TT3 offset TT2 - 1,
   TT4 cat [TT3, [0]],
   TT5 derivative TT4 / Year,
   TT6 derivative TT5 / Year,
   TT7 offset TT6 - 1,
   TT8 cat [TT7, [0]],
   % Omega2 is 1.0,
   Omega2 mapdot -1*mathieu_modulater(1) ~> Year, % 0.8
   Scaled0 mapdot Omega2 * TTT,
   Front range 1*[1,1214],  % 1188 1215
   Middle range Flip*[1215,1273],  % 1386
   Back range 1*[1274,L],  % 1387
   Clip cat [Front,Middle,Back],
       % Offset invert Clip,

   TTa mapdot TT4 - 0.00 .* TT5, %0.041
   TT mapdot  TTa + 0.000 .* TT8,
   %TT mapdot TTa + TTb,
   Scal is -0.35+0.2*Flip,
   Scaled mapdot Scaled0 + 0*Scal*0.065 .* TT,
   % Scaled mapdot Scaled0 - 3.06 .* TT,
   % Scaled mapdot Scaled0 + 24.8 .* TT,
   (  Second ->
      T mapdot TT * Clip
      % T = TT
   ;
      T mapdot Scaled * Clip
      % T = Scaled
   ),
   Offset mapdot 0 .* TT.


get_years_from_1880(T, Years, Zeros) :-
    length(T, L),
    H range [1, L]/1,
    Y mapdot H ./ 12.0,
    Years mapdot 1880 .+ Y,
    Zeros mapdot 0 .* H.

get_months_from_start(T, H) :-
    length(T, L),
    H range [1, L]/1.

is_proper_float(X) :-
catch(_ is X+0.0, _, fail).


check_coefficients([], List, Final ) :- reverse(List, Final), !.
check_coefficients([F|Rest], List, Final ) :-
    % print(user_error, ['v=', F]),
    % F = '$NaN', !, %  '$NaN'
    is_proper_float(F),
    check_coefficients(Rest, [F|List], Final).
% check_coefficients([F|Rest], List, Final ) :-
%    F = 'NA', !,
%    check_coefficients(Rest, [0.0|List], Final).
check_coefficients([_|Rest], List, Final ) :-
    check_coefficients(Rest, [0.0|List], Final).

show_rms([], Out, Out).
show_rms([[Name,A]|R], In, Out) :-
    rms(A, RMS),
    R1000 is 1000*RMS,
    format(atom(Value), '~1f', [R1000]),
    show_rms(R, [[Name,Value]|In], Out).
show_rms(Array, Values) :-
    show_rms(Array, [], Values).

show_equation([], Out, Out).
show_equation([[0.0,0.0,0.0]|R], In, Out) :-
    show_equation(R,In, Out).
show_equation([[Period,S,C]|R], In, Out) :-
    Val is sqrt(S*S+C*C),
    Phase is atan(S,C),
    Per is Period/12.0,
    format(atom(Value), '+ ~5g * sin(2*pi()*$a1/~5g+~5g) ', [Val,Per,Phase]),
    concat(In, Value, Eq),
    show_equation(R,Eq, Out).

show_periods([], Out, Out).
show_periods([[0.0,0.0,0.0]|R], In, Out) :-
    show_periods(R, In, Out).
show_periods([[Period,S,C]|R], In, Out) :-
    RMS is sqrt(S*S+C*C),
    format(atom(Value), '~3f', [RMS]),
    Year is Period / 12,
    % format(atom(Name), '~dyears', [Year]),
    show_periods(R, [[Year,Value]|In], Out).

show_periods(Array, out(Values, Equation)) :-
    show_periods(Array, [], Values),
    show_equation(Array, '', Equation).

html_rms(RMS, _, _) --> {var(RMS)}.
html_rms(RMS, Periodic, Equation) -->
	html(
	    [
	    \(con_text:multi_columns([
		     /* div([
			 p(i('Temperature variance as RMS values in milliKelvin, baseline=1960')),
			 \(con_text:table_multiple_entries([[factor,rms]],RMS))
			 % \(con_text:paragraphs(RMS))
		       ]), */
		     div([
			 % p(i('Individual periodic cycles in years')),
			 \(con_text:table_multiple_entries([[period,rms]],Periodic))
			 % \(con_text:paragraphs(Periodic))
			])
			       ]
				     )
	      ),
	    p(Equation)
	    ]
	    ).    % .

zero_range([], [], Res, Res) :- !.
zero_range([Delta|Tr], [_TD|TDr], Res, U) :-
    abs(Delta) < 1.0e-12,
    !, zero_range(Tr, TDr, [0.0|Res], U).
zero_range([_T|Tr], [TD|TDr], Res, U) :-
    !,zero_range(Tr, TDr, [TD|Res], U).

select_period(false,QBO,_,R,_Add) :- R is QBO*12.
select_period(true,_,ENSO,R,1*_) :- R is ENSO*12, !.
select_period(true,_,ENSO,R,0*1) :- R is ENSO*12, !.
select_period(true,_,ENSO,0.0,0*0).

plot(Request) :-
    http_parameters(Request, [kind(volcanos, [])]),
    context_box_model:volcano_data(Data),
    reply_html_page([title('volcano data'),
                       \(con_text:style)],
                      [
                       \(con_text:table_multiple_entries(
                                      [['eruption',year,month,'month#',intensity, 'VEI']],
                                      Data
                                                        ))
                      ]
                     ).

plot(Request) :-
    garbage_collect,
    http_parameters(Request, [kind(Kind, []),
			      long(Long, [boolean, default(false)]),
			      fft(FFT, [boolean, default(false)]),
			      window(Window, [boolean, default(false)]),
			      triple(Triple, [boolean, default(false)]),
			      boost(Boost, [float, default(1)]),
			      eq(EQ_ON, [boolean, default(false)]),
			      second_derivative(Second, [boolean, default(false)]),
			      sign(SignMetric, [boolean, default(false)]),
			      wave(WL, [integer, default(0)]),
			      fit_res(Fit, [integer, default(0)]),
			      high_res(Add, [integer, default(0)]),
			      t_units(Cal, []),
			      startYear(StartYear, [integer]),
			      fitYear(FitYear, [integer]),
			      lag(LagCal, [float]),
			      days(Days, [float]),
			      drac(Draconic, [float]),
			      trop(Tropical, [float]),
			      anom(Anomalistic, [float]),
			      mfpr(MfPrime, [float]),
			      evec(Evectional, [float]),
			      syno(Synodical, [float]),
			      % amo_win(NL, [number]),
			      % arctic_win(AW, [number]),
                              dataset(DataSet, []),
                              evaluate(Characteristic, [default(model)])]),

    scale(FFT, LogLin, Characteristic, XLabel, XUnits, YLabel, YUnits, Show_Error_Bars),
    scaling(Cal, month, Scale),
    Lag is Scale*LagCal,

    % Get the temperature series
    % FitF is 1.0*Fit,
    temperature_series(Second, Window, Triple, DataSet, T, Fit, Correction),

    get_years_from_1880(T, Year, Zeros),


    get_months_from_start(T, Months),

    Q is 1.0,
    Sc is 0.995+0.005,
/*
    Days is 365.242181*1.0001, % *0.9994, % 1.0004
    Draconic = 27.21222081,
    Tropical = 27.32158224,
    Anomalistic = 27.554549878,
    Evectional = 31.8119,
    MfPrime is 13.633*2,
    Synodical is 29.53058885,
*/
    Drac is 1/(1/Draconic*Days - 13),
    % Drac is 2.359097,  % 2.37
    Drac1 is 1/(1/Drac + 1),  % 0.7
    Drac2 is 1/(1/Drac + 2),  % 0.41
    Drac3 is 1/(1/Drac + 3),  % 0.29
    % Drac4 is 1/(1/Drac + 4),  % 0.222
    Drac4 is 0.7967,  % 0.222
    % Drac5 is 1/(1/Drac + 5),  % 0.184
    Trop is 1/(1/Tropical*Days - 13), %    Trop is 2.711, % 2.715
    Trop1 is 1/(1/Trop + 1),  % 0.7
    MfP is 1/(1/MfPrime*Days - 13), %    Trop is 2.711, % 2.715
    Drac5 is 1/(1/MfP + 1),  % 0.7
    Evec is 1/(1/Evectional*Days - 11),
    Synod is -1/(1/Synodical*Days - 13),
    SynodHalf is 1/(2/Synodical*Days - 2*12),
    AnomHalf is 1/(2/Anomalistic*Days - 2*13),
    Anom is 1/(1/Anomalistic*Days - 14),
    Anom1 is 1/(1/Anom + 1),  % 0.7

    % P  is Sc*Drac*12, % 2.351 *2*pi/2.6532*12, %  27.21 draconic 2.6532
    Drac_F is Draconic/Days,
    select_period(Long, Drac, Drac, Period,1*Add),
    % Period2 is Sc*Trop*12, %2*pi/2.3157*12, %  27.32 tropical
    select_period(Long, Trop, Trop, Period2,1*Add),
    % Period3 is Sc*Drac1*12, % 0.701 4.15 3.0243*12, %  27.093 also  31.81 evection
    select_period(Long, Drac1, 4.425, Period3,1*Add),
    % Period4 is Sc*Drac2*12, % 0.4129 1.73 3.53 Add*Hale/1 *12 *Q,
    select_period(Long, Drac2, 19.2, Period4,1*Add), % 18.613
    % Period5 is Sc*Drac3*12, % 0.317 18.6 0.717 2.505 1.93 1.583 0*7.944*12, % 7.944 2.54  Venus 9.315*12*Q,  %
    select_period(Long, Drac3, 4.04, Period5,0*Add), % 4.06
/*
    A1 is 2*pi/2.701,
    A2 is 2*pi/2.592,
    A3 is 2*pi/2.628,
    A4 is 2*pi/2.983,
    A5 is 9.07, % 2*pi/0.692,

    select_period(Long, Drac, A1, Period,1*Add),
    select_period(Long, Trop, A2, Period2,1*Add),
    select_period(Long, Drac1, A3, Period3,1*Add),
    select_period(Long, Drac2, A4, Period4,1*Add), % 18.613
    select_period(Long, Drac3, A5, Period5,0*Add), % 4.06
*/

    % Period6 is Sc*Drac4*12, % 0.222 1.583 9.3 2*pi/1.6055*12, %  27.55 weak
    select_period(Long, Drac4, 3.5743, Period6,1*Add), % 6.65
    % Period7 is Sc*Drac5*12,  % 0.1825 1.35777 18.6 2*pi/1.266993*12, %  27.67 weak
    select_period(Long, Drac5, 6.5, Period7,1*Add), % 9.3067

    % Period8 is -Anom*12, % 1.344  2*pi/2.475*12 27.555 anomalistic
    select_period(Long, -Anom, Anom1, Period8,1*Add), %3.64
    Period9 is Evec*12,       % 2.094 14.77 spin-orbit

    %PeriodA is 2.975*12, % Hale/6 *12 *Q,
    select_period(Long, 2.975, 2.898, PeriodA,1*Add),
    % PeriodB is AnomHalf*12, % 1.954 12*31.786/365.242, 1.965*12, 2*pi/3.0255*12, %  31.81 evection
    select_period(Long, AnomHalf, 42.66, PeriodB,1*Add), % 42.66, 8.8512
    % PeriodC is MfP*12, % 2.528 Sc*8.848*12/2, % 1.7579*12, %  1305.48  somewhat weak
    select_period(Long, MfP, MfP, PeriodC,1*Add),

    Year1 is 365.259/Days,
    % PeriodD is Sc*365.259/Days*12, % 1.009  2*pi/2.5054 13.63
    select_period(Long, Year1, 7.37, PeriodD,0*Add), % 7.42

    YearThird is 121.749/Days,
    % PeriodE is Sc*121.749/Days*12, % 23.918 18.6 0.73085554 13.52 0*Hale/2 *12,
    select_period(Long, YearThird, 13.51, PeriodE,0*Add),

    (	Fit = 1 ->
        true % PeriodE is Drac5*12 %0.1825 1.35777 2*pi/1.266993*12, %27.67 weak
	;
        true % PeriodE is SynodHalf*12 % 1.35777 0.1825
    ),
    % PeriodF is Add*Trop1*12, % 0.8245 Trop1 18.6 2*pi/1.266993*12, %  27.67 weak
    select_period(Long, Trop1, 9.07, PeriodF,1*Add), %3.53
    % Period7 is Sc*2*pi/1.94405*12, %  27.44
    %PeriodH is Add*Synod*12, % 0.222 1.583, 9.3 2*pi/1.6055*12 %  27.55 weak
    %PeriodH is 0.2428*12, % 0.2427 0.222 1.583, 9.3 2*pi/1.6055*12 %  27.55 weak
    select_period(Long, 0.2428, 5.65, PeriodH,0*Add), % 5.695

    Sin mapdot mod_sin_period(Period,1,WL) ~> Months,
    Cos mapdot mod_cos_period(Period,1,WL) ~> Months,
    Sin2 mapdot mod_sin_period(Period2,2,WL) ~> Months,
    Cos2 mapdot mod_cos_period(Period2,2,WL) ~> Months,
    Sin3 mapdot mod_sin_period(Period3,3,WL) ~> Months,
    Cos3 mapdot mod_cos_period(Period3,3,WL) ~> Months,
    Sin4 mapdot mod_sin_period(Period4,4,WL) ~> Months,
    Cos4 mapdot mod_cos_period(Period4,4,WL) ~> Months,
    Sin5 mapdot mod_sin_period(Period5,5,WL) ~> Months,
    Cos5 mapdot mod_cos_period(Period5,5,WL) ~> Months,
    Sin6 mapdot mod_sin_period(Period6,6,WL) ~> Months,
    Cos6 mapdot mod_cos_period(Period6,6,WL) ~> Months,
    Sin7 mapdot mod_sin_period(Period7,7,WL) ~> Months,
    Cos7 mapdot mod_cos_period(Period7,7,WL) ~> Months,
    Sin8 mapdot mod_sin_period(Period8,8 ,WL) ~> Months,
    Cos8 mapdot mod_cos_period(Period8,8 ,WL) ~> Months,
    Sin9 mapdot mod_sin_period(Period9,9 ,WL) ~> Months,
    Cos9 mapdot mod_cos_period(Period9,9 ,WL) ~> Months,
    SinA mapdot mod_sin_period(PeriodA,10,WL) ~> Months,
    CosA mapdot mod_cos_period(PeriodA,10,WL) ~> Months,
    SinB mapdot mod_sin_period(PeriodB,11 ,WL) ~> Months,
    CosB mapdot mod_cos_period(PeriodB,11 ,WL) ~> Months,
    SinC mapdot mod_sin_period(PeriodC,12 ,WL) ~> Months,
    CosC mapdot mod_cos_period(PeriodC,12 ,WL) ~> Months,
    SinD mapdot mod_sin_period(PeriodD,13,WL) ~> Months,
    CosD mapdot mod_cos_period(PeriodD,13,WL) ~> Months,
    SinE mapdot mod_sin_period(PeriodE,14,WL) ~> Months,
    CosE mapdot mod_cos_period(PeriodE,14,WL) ~> Months,
    SinF mapdot mod_sin_period(PeriodF,15,WL) ~> Months,
    CosF mapdot mod_cos_period(PeriodF,15 ,WL) ~> Months,
    Sin0 mapdot mod_sin_period(PeriodH,16,WL) ~> Months,
    Cos0 mapdot mod_cos_period(PeriodH,16,WL) ~> Months,

    Beat_Node is 1/(1/Draconic-1/Tropical)/Days,
    Beat_Anom is 1/(1/Tropical-1/Anomalistic)/Days,

    % Evection is Beat_Anom/4*12, % 2.21175 3.813 4.59 6.48,
    % Evection is 12*1.0,
    BA4 is   Beat_Anom/4, % 2.25
    select_period(Long, BA4, BA4, Evection,1*Add),
    LogCO2 mapdot mod_sin_period(Evection,17,WL) ~> Months,
    S2 mapdot mod_cos_period(Evection,17,WL) ~> Months,

    % CWobble is Beat_Node/8*12,  % 2.32667 1.7579 1.595 1.185*12,
    BN4 is  Beat_Node/8,
    select_period(Long, BN4, BN4, CWobble,1*Add),
    V1 mapdot mod_sin_period(CWobble,18,WL) ~> Months,
    LOD_F mapdot mod_cos_period(CWobble,18,WL) ~> Months,

    YearHalf is 182.621/Days,
    % K1 is 182.621/Days*12, % 2.3347*12, % 5.9935 12*3.79,
    %select_period(Long, YearHalf, 4.2667, K1,0*Add), % 0.08721149897330595
    select_period(Long, YearHalf, 2.274, K1,0*Add), % 0.08721149897330595
    % select_period(Long, YearHalf, Evec, K1), %3.64
    % select_period(Long, YearHalf, 100.0, K1),

    TSI_F mapdot yearly_sin_period(K1,0,WL) ~> Months,
    AAM mapdot yearly_cos_period(K1,0,WL) ~> Months,
    %AAM mapdot sin_biennial_period ~> Months,
    %LOD_F mapdot cos_biennial_period ~> Months,

    get_fit(StartYear, FitYear, [T, LogCO2, S2,V1, LOD_F,  TSI_F, AAM, Sin0, Cos0, % Arctic, NAO,
	                                                        Sin,  Cos,  Sin2, Cos2,
	                                                        Sin3, Cos3, Sin4, Cos4,
								Sin5, Cos5, Sin6, Cos6,
								Sin7, Cos7, Sin8, Cos8,
	                                                        Sin9, Cos9, SinA, CosA,
	                                                        SinB, CosB, SinC, CosC,
	                                                        SinD, CosD, SinE, CosE,
	                                                        SinF, CosF],
	    Coefficients, Int, _R2C),
	    % [NoiseA, C, SO, TS, VC,   LO],

    check_coefficients(Coefficients, [], [C, SO, VC,   LO,  TS, AA, SW0, CW0, % ARC, NI,
					                           SW,  CW,  SW2, CW2,
					                           SW3, CW3, SW4, CW4,
					                           SW5, CW5, SW6, CW6,
					                           SW7, CW7, SW8, CW8,
					                           SW9, CW9, SWA, CWA,
					                           SWB, CWB, SWC, CWC,
					                           SWD, CWD, SWE, CWE,
					                           SWF, CWF]),

    Fluct mapdot SO .* S2 + VC .* V1 + LO .* LOD_F +  TS .* TSI_F +  AA .* AAM +
                                          + SW0 .* Sin0 + CW0 .* Cos0  % ARC .* Arctic + NI .* NAO
		                           + SW .* Sin + CW .* Cos
		                           + SW2 .* Sin2 + CW2 .* Cos2
		                           + SW3 .* Sin3 + CW3 .* Cos3
		                           + SW4 .* Sin4 + CW4 .* Cos4
		                           + SW5 .* Sin5 + CW5 .* Cos5
		                           + SW6 .* Sin6 + CW6 .* Cos6
		                           + SW7 .* Sin7 + CW7 .* Cos7
		                           + SW8 .* Sin8 + CW8 .* Cos8
		                           + SW9 .* Sin9 + CW9 .* Cos9
		                           + SWA .* SinA + CWA .* CosA
		                           + SWB .* SinB + CWB .* CosB
		                           + SWC .* SinC + CWC .* CosC
		                           + SWD .* SinD + CWD .* CosD
		                           + SWE .* SinE + CWE .* CosE
		                           + SWF .* SinF + CWF .* CosF
					   ,

    T_CO2_R mapdot C .* LogCO2 + Fluct,
    T_R mapdot Int .+ T_CO2_R,
    T_Diff mapdot T - T_R,
    %
    % Drift_Baseline mapdot C .* LogCO2 + LO .* LOD_F,
    % T_From_Baseline mapdot T - Drift_Baseline,
    !,
    sum_of_squares(T, T_R, Sum_of_Sq),
    length(Months, Length_Series),
    Error_Bar is 2*sqrt(Sum_of_Sq/Length_Series),

    T_lag lag T / Lag,
    Lag1 is 0*Lag,   %%%%%%%%%%%%%%%%%%%%%%%%%%  Lag is smaller on model
    T_R_lag1 lag T_R / Lag1,
    T_R_mod mapdot Boost*yearly_qmod ~> Months,
    T_R_lag mapdot T_R_mod * T_R_lag1,
    (   EQ_ON ->
        T_lag0 = T_lag,
        T_R_lag0 = T_R_lag
    ;
        SY is (StartYear - 1880)*12+1,
        FY is (FitYear - 1880)*12 + 1,
	% Wi is FY - SY,
        RC range [SY,FY]/1,
	% offset
        T_lag00 offset T_lag - SY,
        T_R_lag00 offset T_R_lag - SY,
        T_lag0 shrink T_lag00 / RC,
        T_R_lag0 shrink T_R_lag00 / RC
    ),
    % corrcoeff(T_lag0, T_R_lag0, R2C20),
    (	SignMetric ->
        excursion(T_lag0, T_R_lag0, R2C20)
    ;
	 % median_filter(T_lag0, T_med),
        corrcoeff(T_lag0, T_R_lag0, R2C20)
    ),
    R2C2 is 100.0*R2C20,
    (
       Characteristic = model ->
    /*
          r_open_session,
          r_in( library(dcv) ),
          model <- T_lag,
          data <- T_R_lag,
          r_in('test.RE(Model, data)'),
          r_close,
     */
         %T_lag_low mapdot T_lag .- Error_Bar,
         %T_lag_high mapdot Error_Bar .+ T_lag,
         %T_lags tuple T_lag_low + T_lag + T_lag_high,
         %T_R_lags tuple T_R_lag + T_R_lag + T_R_lag,
         %Corrections tuple Correction + Correction + Correction,
	 % Data group Year + T_lag + T_R_lag, % + Corrections,
	 Data tuple Year + T_lag + T_R_lag, % + Corrections,
         Header = [XLabel, DataSet, model], % , correction]
         RMS = 1.0,
	 show_periods([[Evection,C, SO],
		       [CWobble, VC, LO],  %V1 VC, LOD_F LO,  TSI_F TS, AAM AA
		       [K1, TS, AA],
	               [PeriodH, SW0, CW0],
	               [Period, SW, CW],
		       [Period2, SW2, CW2],
		       [Period3, SW3, CW3],
		       [Period4, SW4, CW4],
		       [Period5, SW5, CW5],
		       [Period6, SW6, CW6],
		       [Period7, SW7, CW7],
		       [Period8, SW8, CW8],
		       [Period9, SW9, CW9],
		       [PeriodA, SWA, CWA],
		       [PeriodB, SWB, CWB],
		       [PeriodC, SWC, CWC],
		       [PeriodD, SWD, CWD],
		       [PeriodE, SWE, CWE],
		       [PeriodF, SWF, CWF]
		        ], out(Periodic, Equation))

     ;
       Characteristic = fluctuation ->
         TCO2 mapdot Int .+ C .* LogCO2,
         TFluct mapdot T_lag - TCO2,
         FF lag Fluct / Lag,
         Data tuple Year + TFluct + FF,
         Header = [XLabel, signal,  variability]
    ;
         Characteristic = map ->
	 Data tuple T_R_lag + T_lag,
         Header = [model, DataSet]
     ;
       Characteristic = cross ->
         S0S2 mapdot SO .* S2,
         TSTSI_F mapdot TS .* TSI_F,
         VCV1 mapdot VC .* V1,
	 LOLOD_F mapdot LO .* LOD_F,
         AAM_D mapdot AA .* AAM,
	 Waves1 mapdot SW .* Sin + CW .* Cos,
	 Waves2 mapdot SW2 .* Sin2 + CW2 .* Cos2,
         Waves3 mapdot SW3 .* Sin3 + CW3 .* Cos3,
         Waves4 mapdot SW4 .* Sin4 + CW4 .* Cos4,
	 Waves5 mapdot SW5 .* Sin5 + CW5 .* Cos5,
         Waves6 mapdot SW6 .* Sin6 + CW6 .* Cos6,
	 Waves7 mapdot SW7 .* Sin7 + CW7 .* Cos7,
         Waves8 mapdot SW8 .* Sin8 + CW8 .* Cos8,
	 Waves9 mapdot SW9 .* Sin9 + CW9 .* Cos9,
	 WavesA mapdot SWA .* SinA + CWA .* CosA,
	 WavesB mapdot SWB .* SinB + CWB .* CosB,
	 WavesC mapdot SWC .* SinC + CWC .* CosC,
	 WavesD mapdot SWD .* SinD + CWD .* CosD,
	 WavesE mapdot SWE .* SinE + CWE .* CosE,
	 WavesF mapdot SWF .* SinF + CWF .* CosF,

	 CO2_Strength mapdot C .* LogCO2,
         Data tuple Year + CO2_Strength + S0S2 + VCV1 + LOLOD_F + TSTSI_F + AAM_D +
	            Waves1 + Waves2 + Waves3 + Waves4 + Waves5 + Waves6 + Waves7 + Waves8 + Waves9 +
		    WavesA + WavesB + WavesC + WavesD + WavesE + WavesF ,
	 Header = [XLabel, co2, soi,   aero,  lod, tsi,	aam, barys, baryc,
		   p_22_3, p_9, p_18_6, p_8_85, p_11_86, p_3_22, p_11_86_2, p_18_6_3, p_8_85_2,
		   p_5_30, p_4_20, p_22_6, p_22_2, p_22_1, p_3_35, p_27, p_2_46, p_2_00, p_9_3]

     ;

       Characteristic = cycles ->
	 Cycle1 mapdot SW .*  Sin +  CW .*  Cos +  SWA .* SinA + CWA .* CosA +
	               SWB .* SinB + CWB .* CosB + SWC .* SinC + CWC .* CosC +
		       SWD .* SinD + CWD .* CosD + SWE .* SinE + CWE .* CosE,
         Cycle2 mapdot SW2 .* Sin2 + CW2 .* Cos2 + SW6 .* Sin6 + CW6 .* Cos6,
	 Cycle3 mapdot SW3 .* Sin3 + CW3 .* Cos3 + SW8 .* Sin8 + CW8 .* Cos8,
	 Cycle4 mapdot SW4 .* Sin4 + CW4 .* Cos4 + SW9 .* Sin9 + CW9 .* Cos9,
         Cycle5 mapdot SW5 .* Sin5 + CW5 .* Cos5 + SW7 .* Sin7 + CW7 .* Cos7,
         Cycle6 mapdot SWF .* SinF + CWF .* CosF,
	 AllCycles mapdot Cycle1 + Cycle2 +Cycle3 +Cycle4 + Cycle5 + Cycle6,
         S0S2 mapdot SO .* S2,
         % TSTSI_F mapdot TS .* TSI_F,
         AAM_D mapdot AA .* AAM,
	 AllNatural mapdot AAM_D + S0S2,
	 Data tuple Year + AllCycles + AllNatural,
         % Header = [XLabel, '22',   '18.03', '18.6',  '8.85',  '11.86', '2']
         Header = [XLabel, 'cycles', 'natural'],
	 corrcoeff(AllCycles, AllNatural, CycleCC),
	 print(user_error, [cycleCC, CycleCC])

     ;
       Characteristic = residual ->
         (   FFT ->
	     zero_range(T, T_Diff, [], T_Diff2),
	     R_FFT fft T_Diff2,
	     Range ordinal R_FFT,
	     Data tuple Range + R_FFT
	 ;
             % T_Base mapdot Int .+ C .* LogCO2 + LO .* LOD_F ,
             % Noise_Level mapdot T - T_Base,
	     % RHV mapdot NI .* NAO,
	     % get_qbo(QBO),
	     % S0S2 mapdot 4*SO .* S2,
	     % LM2 mapdot 4*LM .* LogMethane,
	     %corrcoeff(T_Diff, S0S2, R2C2),
	     % zero_range(T, T_Diff, [], T_Diff2),
	     Data tuple Year + T_Diff % + S0S2 +LM2   %  + Noise_Level
	 ),

         Header = [XLabel, residual, soi_t, soi_d] % , fluctuation]
     ;
       Characteristic = signal ->
         CO2_Signal mapdot Int .+ C .* LogCO2,
         Signal mapdot CO2_Signal + T_Diff,
         % median_filter(Sig, Signal),
         Data tuple Year + Signal + CO2_Signal + Fluct,
         Header = [XLabel, signal,  co2,         fluctuation]
     ;
       Characteristic = correlate ->
         CO2_Signal mapdot Int .+ C .* LogCO2,
         Signal mapdot CO2_Signal + T_Diff,
         Data tuple CO2_Signal + Signal + CO2_Signal,
         Header = [co2, data, log_model]
     ;
       Characteristic = all ->
         TSTSI_F mapdot 9 .+ TS .* TSI_F,
         S0S2 mapdot 8 .+ SO .* S2,
         VCV1 mapdot 7 .+ VC .* V1,
	 LOLOD_F mapdot 5 .+ LO .* LOD_F,
         % Noise_D mapdot NoiseA .* Noise2,
         AAM_D mapdot 4 .+ AA .* AAM,
         % ARCTIC_D mapdot ARC .* Arctic,
         % NAO_D mapdot NI .* NAO,
	 Diurnal mapdot 3 .+ SW3 .* Sin3 + CW3 .* Cos3 +
	                SW8 .* Sin8 + CW8 .* Cos8,
	 SemiDiurnal mapdot 2 .+ SW4 .* Sin4 + CW4 .* Cos4 +
	                    SW9 .* Sin9 + CW9 .* Cos9,
	 % HaleCycle mapdot 0.1 .+ SW .* Sin + CW .* Cos +
	 %               SWC .* SinC + CWC .* CosC +
	 %               SWD .* SinD + CWD .* CosD +
	 %               SWE .* SinE + CWE .* CosE,
	 HaleCycle mapdot 1 .+ SW .* Sin + CW .* Cos +
	                SWA .* SinA + CWA .* CosA +
	                SW5 .* Sin5 + CW5 .* Cos5,
	 % Jupiter mapdot 0.2 .+ SW5 .* Sin5 + CW5 .* Cos5 +
	 %                SW7 .* Sin7 + CW7 .* Cos7,
	 SunMoonEarth  mapdot SW2 .* Sin2 + CW2 .* Cos2,
			 % SWH .* SinH + CWH .* CosH,
	 Cycle_20_80 mapdot -1 .+ SWF .* SinF + CWF .* CosF +
	                SW6 .* Sin6 + CW6 .* Cos6 +
	                SWA .* SinA + CWA .* CosA +
	                SWB .* SinB + CWB .* CosB,

	 Waves mapdot SW .* Sin + CW .* Cos + SW2 .* Sin2 + CW2 .* Cos2
                                              + SW3 .* Sin3 + CW3 .* Cos3
                                              + SW4 .* Sin4 + CW4 .* Cos4
					      + SW5 .* Sin5 + CW5 .* Cos5
                                              + SW6 .* Sin6 + CW6 .* Cos6
					      + SW7 .* Sin7 + CW7 .* Cos7
                                              + SW8 .* Sin8 + CW8 .* Cos8
                                              + SW9 .* Sin9 + CW9 .* Cos9, % Check

	 CO2_Strength mapdot Int .+ C .* LogCO2,
	 % Meth mapdot -0.2 .+ LM .* LogMethane,
	 ResidNoise mapdot -0.3 .+ T_Diff,
	 show_rms([% [amo, NAO_D],
		   % [arctic, ARCTIC_D],
		   ['set of orbital cycles',Waves],
		   [tsi,TSTSI_F],
		   [aero, VCV1],
		   [aam,AAM_D],
		   [soi,S0S2],
		   [lod,LOLOD_F],
		   [co2, CO2_Strength]], RMS),
	 show_periods([[Period, SW, CW],
		       [Period2, SW2, CW2],
		       [Period3, SW3, CW3],
		       [Period4, SW4, CW4],
		       [Period5, SW5, CW5],
		       [Period6, SW6, CW6],
		       [Period7, SW7, CW7],
		       [Period8, SW8, CW8],
		       [Period9, SW9, CW9],
		       [PeriodA, SWA, CWA],
		       [PeriodB, SWB, CWB],
		       [PeriodC, SWC, CWC],
		       [PeriodD, SWD, CWD],
		       [PeriodE, SWE, CWE],
		       [PeriodF, SWF, CWF]
		        ], out(Periodic, Equation)),

     /*
         Angular mapdot AAM_D + LOLOD_F + Y_Lunar,
         Data tuple Year + S0S2 + VCV1 + TSTSI_F + ARCTIC_D + NAO_D + Angular,
	 Header = [XLabel, soi,   aero,  tsi,      arctic,    nao,    angular]
     */
	 % Double mapdot SemiDiurnal + SunMoonEarth,
         Data tuple Year + TSTSI_F + S0S2 + VCV1 + LOLOD_F + AAM_D +
	                   Diurnal %
			   +SemiDiurnal
			   % + Double
			   + HaleCycle % + Jupiter + Venus
			   + SunMoonEarth
			   + Cycle_20_80 + ResidNoise + CO2_Strength, % + Meth,
	 Header = [XLabel, tsi,  soi, aero,      lod,      aam,
		           diurnal, semi, hale, % jupiter, venus,
		           sme,
		           '20/80', residual,co2] % , methane]

    ),
    temp_data(NameData, DataSet),
    TCR is C*ln(2),
    PPP is Period7/12,
    print(user_error, ['random period ', PPP]),

    (	Kind = graph ->
    reply_html_page([title('GISS and SOI'),
                     \(con_text:style)],
                    [
		     table([tr([th('R=cc')        ]),
			    tr([td(b('~5f'-R2C2))      ])
			   ]),

		     table( % [class('fixed')],
			   [caption(div([id('legend')],[])),
			    tr([
				td(
		       \(context_graphing:dygraph_error_bars_base(LogLin, Header,
						       [XLabel,XUnits], [YLabel, YUnits],
						       [NameData, ':', FitYear, ' - lunar:', Characteristic, ' 2nd:', Second ], Data, Show_Error_Bars, 1600))
		     % \(context_graphing:dygraph_native(LogLin, Header,
		%				       [XLabel,XUnits], [YLabel, YUnits],
		%				       [NameData, FitYear, ' - ENSO:', Characteristic], Data))
				  )
			       ])]),
		     br([]),
		     % br([]),
		     % p(i('TCR = ~4f C for doubling of CO2'-TCR)),
		     \html_rms(RMS, Periodic, Equation)
                    ]
		  )
   ;
      reply_html_page([title(Characteristic),
                       \(con_text:style)],
                      [
                       \(con_text:table_multiple_entries(
                                      [Header],
                                      Data
                                                        ))
                      ]
                     )

    ).







