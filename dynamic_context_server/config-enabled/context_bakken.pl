:- module(context_bakken, [
				cumulative_diffusional_dispersion/5
				% exp_lag/3
			    ]).

/** <module> Growth of production in a tight oil model
    * Diffusional cumulative model convolved against the growth of wells
    *
*/

:- use_module(context_math).

:- context:register(context_bakken:navigate).
:- context:register(context_bakken:plot).


cumulative_diffusional_dispersion(Amp, D, Theta, Year, Result) :-
    Tau is (1-exp(-Theta*Year))/Theta,
    Result is Amp/(1+sqrt(D/(Tau+0.0001))).



%%   navigate(+Request)
%
%    Dynamic page to tight oil growth
navigate(Request) :-
   % collect_unit_options(time, Tunits),

   reply_html_page(cliopatria(default),
                   [title('Red Queen model - tight oil'),
	           script([type('text/javascript'),src('/html/js/submit.js')], [])
                   ],
                   [\(con_text:table_with_iframe_target(
                                    Request,
		     [
                      h1('Plot a Red Queen model - tight oil'),
                      p('Number of cumulative wells'),
                      form([action(plot), target(target_iframe)],
			 [
			  % select([name('t_units')], Tunits),
			  input([type('text'),
				 name('limit'),
				 value('150')]), i(' <= projected rate of growth per month'),
			  br([]),
			  input([type('text'),
				 name('extra'),
				 value('240')]), i(' <= number of future months'),
			  br([]),
			  \(con_text:radio_toggles(
					 'evaluate',
					 [['Cumulative', 'cumulative'],
					  ['Daily', 'daily'],
					  ['Single Well', 'well']
                                         ])),
                          br([]),
			  input([type('submit'), name(kind), value('plot'),
                                 onclick('subm(this.form,"target_iframe");')]),
			  input([type('submit'), name(kind), value('table'),
                                 onclick('subm(this.form,"render");')])
			 ]
                          ),

                      br([]),
		      \(con_text:render_iframe(render))
                     ]
						       ))
     ]
		  ).



%%   plot(+Request)
%
%    Plot the Red Queen model profile
plot(Request) :-
    http_parameters(Request, [kind(table, []),
			      limit(Rate, [number]),
                              extra(Future_Months, [number]),
                              evaluate(_Table, [])]),
    number_of_wells(Rate, Future_Months, Number_Wells),
    length(Number_Wells, L),
    Time range [0, L]/1,
    Data tuple Time + Number_Wells,

    reply_html_page([title('Shock Extraction'),
                     \(con_text:style)],
                    [
		     \(context_graphing:dygraph_native(lin, [date, rate],
						       ['Date', month],
                                                       ['Barrels', cumulative],
						       'Red Queen', Data))
                    ]
		  ).



plot(Request) :-
    http_parameters(Request, [kind(plot, []),
			      limit(Rate, [number]),
                              % t_units(_TUnits, []),
                              extra(Future_Months, [number]),
                              evaluate(Characteristic, [default(cumulative)])]),

    number_of_wells(Rate, Future_Months, Number_Wells),
    length(Number_Wells, L),
    Time range [1, L]/1,

    % Single_Well mapdot cumulative_diffusional_dispersion(6.58, 63200, 0.00745) ~> Time,
    Single_Well mapdot cumulative_diffusional_dispersion(6.7, 64600, 0.0078) ~> Time,
    % Single_Well mapdot cumulative_diffusional_dispersion(6.87, 66000, 0.0085) ~> Time,
    % Single_Well mapdot cumulative_diffusional_dispersion(6.89, 64000, 0.0091) ~> Time,
    Monthly_Wells derivative Number_Wells/Time,
    Total convolve Single_Well*Monthly_Wells,
    (
       Characteristic  = cumulative ->
         daily_bakken(Future_Months, P),
         CP accumulate P,
         Factor is 365/12,
	 CData mapdot Factor .* CP,
	 Data tuple Time + Total + CData,
         Heading = [time,   'Model', 'Data'],
         CC = 0
    ;
       Characteristic = daily  ->
         daily_bakken(Future_Months, P),
         T ordinal Total,
         Months mapdot 1 .+ T,
         Monthly  derivative Total/Months,
         Daily mapdot Monthly ./ 30.4,
	 Data tuple Time + Daily + P,
	 Model shrink Daily/P,
         PO offset P - 35, % Get rid of first few datapoints for sum of squares calc
         MO offset Model - 35,
         sum_of_squares(PO, MO, CC),
         Heading = [time,   'Model', 'Actual']
    ;
       Characteristic = well  ->
	 Data tuple Time + Single_Well,
         Heading = [time,   'Model'],
         CC = 0
    ),
    X = 'time',
    XUnits = ' month',
    YUnits = ' million barrels',
    reply_html_page([title('Red Queen'),
                     \(con_text:style)],
                    [
		     i('CC='), b('~8f ' - CC),
		     \(context_graphing:dygraph_native(lin,
						       Heading,
						       [X,XUnits],
                                                       ['Production', YUnits],
						       Characteristic, Data))
                    ]
		  ).



number_of_wells(Rate, Months, List) :-
   number_of_wells(Start),
   last(Start, Last),
   % Starting is Last + Rate,
   % Ending is Last + Rate*(Months+1),
   Continue range [1,Months]/1,
   Growth mapdot Rate .* Continue,
   Add mapdot Last .+ Growth,
   List cat [Start|Add].

number_of_wells(
[
46,
95,
134,
179,
216,
242,
270,
302,
346,
376,
407,
442,
479,
507,
538,
567,
598,
630,
654,
688,
714,
732,
751,
773,
790,
817,
847,
870,
896,
922,
955,
992,
1014,
1035,
1070,
1109,
1137,
1163,
1192,
1224,
1256,
1283,
1311,
1328,
1354,
1370,
1391,
1414,
1435,
1460,
1490,
1511,
1535,
1554,
1578,
1598,
1610,
1617,
1624,
1624,
1630,
1634,
1638,
1641,
1651,
1654,
1659,
1663,
1670,
1677,
1681,
1684,
1697,
1706,
1720,
1731,
1744,
1755,
1771,
1779,
1799,
1815,
1831,
1842,
1856,
1861,
1873,
1877,
1882,
1887,
1892,
1905,
1912,
1916,
1921,
1935,
1950,
1961,
1968,
1977,
1987,
1995,
2008,
2021,
2032,
2042,
2058,
2073,
2086,
2099,
2116,
2131,
2146,
2155,
2169,
2184,
2205,
2217,
2225,
2235,
2247,
2253,
2256,
2262,
2271,
2280,
2295,
2302,
2309,
2315,
2321,
2333,
2340,
2347,
2353,
2363,
2371,
2383,
2390,
2397,
2402,
2405,
2411,
2418,
2422,
2429,
2438,
2448,
2455,
2463,
2469,
2475,
2478,
2485,
2487,
2491,
2492,
2501,
2506,
2513,
2519,
2528,
2535,
2539,
2547,
2549,
2555,
2561,
2569,
2575,
2582,
2597,
2607,
2623,
2632,
2645,
2652,
2664,
2674,
2683,
2691,
2704,
2714,
2726,
2734,
2743,
2754,
2761,
2766,
2773,
2782,
2790,
2799,
2816,
2827,
2835,
2853,
2867,
2881,
2891,
2902,
2911,
2917,
2925,
2933,
2939,
2946,
2950,
2952,
2957,
2958,
2961,
2964,
2967,
2968,
2969,
2970,
2972,
2973,
2975,
2983,
2986,
2994,
2999,
3002,
3006,
3012,
3018,
3022,
3026,
3035,
3048,
3058,
3064,
3072,
3080,
3086,
3092,
3098,
3107,
3120,
3132,
3148,
3159,
3169,
3180,
3191,
3200,
3208,
3213,
3221,
3227,
3237,
3247,
3251,
3259,
3265,
3269,
3281,
3287,
3292,
3300,
3306,
3316,
3331,
3336,
3344,
3349,
3356,
3369,
3376,
3382,
3393,
3400,
3406,
3418,
3450,
3456,
3465,
3477,
3484,
3496,
3505,
3516,
3525,
3530,
3538,
3549,
3559,
3575,
3607,
3623,
3641,
3652,
3668,
3704,
3749,
3767,
3790,
3808,
3836,
3865,
3881,
3910,
3934,
3952,
3980,
4008,
4031,
4054,
4076,
4100,
4124,
4162,
4191,
4215,
4235,
4264,
4296,
4325,
4365,
4404,
4446,
4497,
4538,
4584,
4641,
4702,
4763,
4802,
4838,
4878,
4917,
4952,
4988,
5044,
5095,
5150,
5200,
5245,
5279,
5313,
5347,
5390,
5450,
5506,
5598,
5679,
5754,
5850,
5928,
6008,
6095,
6159,
6230,
6297,
6378,
6459,
6540,
6639,
6757,
6884,
7014,
7143,
7276,
7410,
7552,
7689,
7864,
8017,
8204,
8369,
8521,
8670,
8848,
9028,
9180,
9339
]
      ).

daily_bakken(Months, List) :-
   daily_bakken(Start),
   last(Start, Last),
   constants(Months, Last, Continue),
   List cat [Start|Continue].

daily_bakken(
[
0.125495605,
0.126441304,
0.12298606,
0.127855726,
0.120222871,
0.123963518,
0.11711931,
0.113106575,
0.126073118,
0.123763923,
0.13022331,
0.129320647,
0.13391589,
0.136938279,
0.134687573,
0.138356942,
0.135589677,
0.177007595,
0.142479584,
0.131106148,
0.14526937,
0.140578027,
0.139653008,
0.136624701,
0.139715605,
0.138468427,
0.137056668,
0.142852767,
0.137723605,
0.136521501,
0.142056921,
0.136727836,
0.146657063,
0.140117227,
0.145654685,
0.142614082,
0.149048384,
0.150608811,
0.142477249,
0.148441249,
0.141516756,
0.145480011,
0.143565271,
0.128851759,
0.145510356,
0.139977238,
0.145851748,
0.139991507,
0.142402389,
0.142908953,
0.137567901,
0.141928603,
0.134719792,
0.13180149,
0.136072899,
0.123539868,
0.1336536,
0.128482816,
0.130818444,
0.124456537,
0.124185041,
0.122523584,
0.115969381,
0.12052606,
0.118748285,
0.121918488,
0.120375584,
0.108196964,
0.11898914,
0.115528175,
0.116635693,
0.11121623,
0.115373819,
0.111241151,
0.109851025,
0.111810542,
0.108161984,
0.11240663,
0.110318301,
0.103850334,
0.111096427,
0.108242696,
0.112223638,
0.108125227,
0.11008149,
0.109287518,
0.104362882,
0.108217282,
0.103417973,
0.10414777,
0.104466312,
0.092885063,
0.10352811,
0.098168548,
0.101432647,
0.096742882,
0.102975748,
0.101748132,
0.097954126,
0.10380651,
0.101373797,
0.10232377,
0.102592636,
0.092957951,
0.103126784,
0.099491901,
0.102623737,
0.098427419,
0.100968033,
0.102016767,
0.099277775,
0.103206181,
0.100555167,
0.10187211,
0.102445151,
0.093620679,
0.103406236,
0.099789797,
0.103191847,
0.098566093,
0.101067616,
0.099731573,
0.093240132,
0.096231255,
0.092743463,
0.095949929,
0.09461543,
0.088999923,
0.094071912,
0.090247134,
0.092289074,
0.088275649,
0.090590236,
0.091149271,
0.088089633,
0.089971858,
0.085652088,
0.08754651,
0.087568241,
0.080234729,
0.088535211,
0.08391337,
0.08664983,
0.084583726,
0.082999266,
0.085026214,
0.083745041,
0.086319386,
0.081444427,
0.081824482,
0.077976066,
0.069935605,
0.076946104,
0.074955814,
0.07821794,
0.074712329,
0.076776296,
0.076473929,
0.074008307,
0.077561753,
0.07457954,
0.077792581,
0.079928153,
0.072118553,
0.081503671,
0.082463342,
0.082136252,
0.07711006,
0.079509238,
0.081981929,
0.079499244,
0.083056767,
0.081229907,
0.083899562,
0.084342411,
0.079540997,
0.087552427,
0.086060877,
0.089040427,
0.087922718,
0.092287693,
0.092719956,
0.090760274,
0.094436745,
0.087916767,
0.089890192,
0.090967529,
0.085919277,
0.094084241,
0.092590521,
0.100979507,
0.098031518,
0.101202444,
0.102160044,
0.09999669,
0.104753721,
0.102272811,
0.105103233,
0.103287156,
0.089779956,
0.099952997,
0.09937223,
0.102366247,
0.097858225,
0.098210433,
0.097689337,
0.093679627,
0.097495726,
0.094332197,
0.095204055,
0.092807244,
0.08368846,
0.09226846,
0.089700132,
0.092693293,
0.089637699,
0.091489447,
0.090119671,
0.087167408,
0.09158949,
0.088175244,
0.091480997,
0.091007342,
0.086295255,
0.092650685,
0.089562082,
0.092146323,
0.088668,
0.090366214,
0.089213227,
0.087708526,
0.092196066,
0.086434455,
0.089422093,
0.090841118,
0.081544011,
0.090027912,
0.086626356,
0.089844658,
0.08438811,
0.087901841,
0.087954707,
0.084897074,
0.087250488,
0.084175233,
0.086352921,
0.086268066,
0.0790344,
0.086391485,
0.083272833,
0.085834126,
0.082358236,
0.084852625,
0.0870336,
0.083477458,
0.08594091,
0.083331945,
0.084818367,
0.084140811,
0.076157556,
0.083208625,
0.079062345,
0.080942696,
0.078843847,
0.081664044,
0.081551014,
0.079583244,
0.0808056,
0.07877714,
0.049199901,
0.080684975,
0.075812219,
0.083700592,
0.082090422,
0.085586236,
0.08326034,
0.085247112,
0.087884581,
0.085796022,
0.08983874,
0.089882334,
0.094387101,
0.091926115,
0.085167912,
0.097231134,
0.092731726,
0.094951068,
0.094276044,
0.099864953,
0.101800208,
0.099976077,
0.104875529,
0.103703079,
0.106247803,
0.10038914,
0.09561166,
0.107835781,
0.101992701,
0.111619036,
0.1100976,
0.112458674,
0.114453468,
0.111695211,
0.115736548,
0.113654532,
0.117297468,
0.117242663,
0.107444022,
0.120359967,
0.117053721,
0.122848044,
0.120688636,
0.126029523,
0.127105118,
0.125347463,
0.131734784,
0.128979353,
0.138629162,
0.140282104,
0.131426433,
0.146551562,
0.148656033,
0.159421118,
0.163941041,
0.176355912,
0.183157644,
0.187295605,
0.207967726,
0.212762038,
0.206055321,
0.191402696,
0.177021008,
0.19905771,
0.193994696,
0.210008121,
0.212127156,
0.232250038,
0.236821545,
0.23490937,
0.244644855,
0.242486005,
0.246749721,
0.240728515,
0.240468263,
0.282776778,
0.28121109,
0.304505852,
0.310792767,
0.328009644,
0.336546214,
0.338546268,
0.350364888,
0.351621501,
0.350575529,
0.349487671,
0.321022948,
0.367071649,
0.34645371,
0.370936471,
0.380511386,
0.433274005,
0.454843068,
0.457222685,
0.497209348,
0.503399047,
0.545329545,
0.55782286,
0.533316888,
0.591611638,
0.603249107,
0.656631485,
0.655361984,
0.689647529,
0.715244121,
0.719349962,
0.763838532,
0.724992789,
0.783630608
]).











