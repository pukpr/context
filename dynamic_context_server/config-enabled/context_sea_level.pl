:- module(context_sea_level, [
			    ]).

:- use_module(context_math).
:- use_module(context_complex).

:- context:register(context_sea_level:navigate).
:- context:register(context_sea_level:plot).

navigate(Request) :-
   collect_unit_options(length, Lunits),

   reply_html_page(cliopatria(default),
                   [title('Sea Level Rise')],
                   [\(con_text:table_with_iframe_target(
                                    Request,
		     [
                      h1('Sea Level Rise'),
                      p('Raw and filtered'),
                      form([action(plot), target(target_iframe)],
			 [
			  select([name('l_units')], Lunits),
			  input([type('text'),
				 name('limit'),
				 value('3')]), i(' <= margin'),
			  br([]),
			  \(con_text:radio_toggles(
					 'evaluate',
					 [['Raw', 'raw'],
                                          ['Filtered', 'filtered'],
                                          ['FFT', 'fft']
                                         ])),
                          br([]),
			  input([type('submit'), name(kind), value('lin')]),
			  input([type('submit'), name(kind), value('log')])
			 ]
                          ),

                      br([]),
		      \(con_text:render_iframe(render))
                     ]
						       ))
     ]
		  ).



plot(Request) :-
    http_parameters(Request, [kind(Kind, []),
			      limit(_Limit, [number]),
                              l_units(LUnits, []),
                              evaluate(Characteristic, [])]),

    slr(SLR),
    (
       Characteristic = raw ->
         X = 'date',
         Y = 'level',
         XUnits = 'year',
         YUnits = LUnits,
         Data = SLR
     ;
       Characteristic = filtered ->  % This is a basic notch filter which removes the 60 day period
         X = 'date',
         Y = 'level',
         XUnits = 'year',
         YUnits = LUnits,
         [Year,Raw] split SLR,
         Offset offset Raw - 3,
         Years offset Year - 3,
         Original shrink Raw/Offset,
         Sum mapdot Original + Offset,
         Filtered mapdot 0.5 .* Sum,
         Data tuple Years + Filtered
      ;
       Characteristic = fft ->
         X = 'wave number',
         Y = 'PSD',
         XUnits = 'discrete',
         YUnits = 'mm^2/mm',
         [Year,Raw] split SLR,
         FFT fft Raw,
         Range ordinal FFT,
         Data tuple Range + FFT
    ),
    reply_html_page([title('Sea Level Rise'),
                     \(con_text:style)],
                    [
		     \(context_graphing:dygraph_native(Kind, [X, Y],
						       [X,XUnits], [Y, YUnits],
						       'Sea Level Rise', Data))
                    ]
		  ).




slr([
[1992.9595,-5.812],
[1992.9866,-7.468],
[1993.0138,-9.105],
[1993.0409,-11.641],
[1993.0681,-11.099],
[1993.0952,-9.353],
[1993.1223,-3.49],
[1993.1495,-2.256],
[1993.1766,-6.592],
[1993.2038,-5.616],
[1993.2309,-2.742],
[1993.2852,-1.935],
[1993.3124,-0.332],
[1993.3395,-5.373],
[1993.3667,-7.421],
[1993.3938,-6.466],
[1993.421,-1.742],
[1993.4481,0.302],
[1993.4753,-1.598],
[1993.5024,-4.235],
[1993.5296,-4.9],
[1993.5839,-2.586],
[1993.611,-2.445],
[1993.6382,-2.338],
[1993.6653,-6.279],
[1993.6925,-7.388],
[1993.7196,-6.414],
[1993.7468,-0.851],
[1993.7739,1.701],
[1993.801,-2.007],
[1993.8553,-7.309],
[1993.8825,-4.693],
[1993.9096,-2.723],
[1993.9368,-0.829],
[1993.9639,1.476],
[1993.9911,-3.792],
[1994.0182,-5.787],
[1994.0454,-1.099],
[1994.0725,2.601],
[1994.0997,-0.956],
[1994.1268,-6.284],
[1994.154,-10.426],
[1994.1811,-2.357],
[1994.2354,1.801],
[1994.2626,0.875],
[1994.2897,-1.042],
[1994.3169,-5.607],
[1994.344,-4.459],
[1994.3712,-1.64],
[1994.3983,-3.675],
[1994.4255,-2.268],
[1994.4526,-3.394],
[1994.5069,-6.171],
[1994.534,-1.327],
[1994.5612,0.363],
[1994.5883,-1.53],
[1994.6155,-7.665],
[1994.6426,-8.048],
[1994.6698,-8.198],
[1994.6969,-0.358],
[1994.7241,-0.824],
[1994.7512,-4.653],
[1994.7784,-5.389],
[1994.8055,-4.569],
[1994.8327,-5.741],
[1994.887,-3.341],
[1994.9141,-10.298],
[1994.9413,-7.955],
[1994.9684,-5.109],
[1994.9956,-0.137],
[1995.0227,2.583],
[1995.0499,2.534],
[1995.077,4.007],
[1995.1042,-3.159],
[1995.1313,-8.62],
[1995.1585,-1.165],
[1995.2128,5.509],
[1995.2399,-2.662],
[1995.267,-4.287],
[1995.2942,-5.893],
[1995.3213,-1.219],
[1995.3756,-1.655],
[1995.4028,-1.058],
[1995.4299,-1.679],
[1995.4571,-3.913],
[1995.4842,-2.327],
[1995.5385,-1.103],
[1995.5657,-2.857],
[1995.5928,-6.28],
[1995.62,-6.979],
[1995.6471,-4.633],
[1995.6743,0.536],
[1995.7014,1.759],
[1995.7286,2.014],
[1995.7557,-4.205],
[1995.7829,-5.691],
[1995.8372,-1.134],
[1995.8643,0.138],
[1995.8915,-1.024],
[1995.9458,-6.196],
[1995.9729,3.58],
[1996,2.205],
[1996.0272,-1.774],
[1996.0543,-4.833],
[1996.0815,-6.774],
[1996.1086,-4.142],
[1996.1629,5.539],
[1996.1901,0.58],
[1996.2172,0.02],
[1996.2444,-1.804],
[1996.2715,-2.779],
[1996.2987,1.424],
[1996.3258,4.58],
[1996.353,2.783],
[1996.3801,-0.239],
[1996.4073,-0.752],
[1996.4344,0.932],
[1996.4887,7.425],
[1996.5159,4.742],
[1996.543,2.938],
[1996.5702,1.413],
[1996.5973,1.916],
[1996.6245,1.79],
[1996.6516,2.896],
[1996.6788,1.598],
[1996.7059,-0.35],
[1996.733,-2.004],
[1996.7602,-1.282],
[1996.8145,-0.091],
[1996.8416,3.344],
[1996.8688,1.113],
[1996.8959,-2.856],
[1996.9231,0.397],
[1996.9502,4.794],
[1996.9774,3.642],
[1997.0045,1.728],
[1997.0317,-0.663],
[1997.0588,-4.829],
[1997.086,1.198],
[1997.1403,3.303],
[1997.1674,1.67],
[1997.1946,-1.654],
[1997.2217,-1.015],
[1997.2489,2.773],
[1997.276,7.376],
[1997.3032,3.808],
[1997.3303,2.724],
[1997.3575,6.89],
[1997.3846,1.988],
[1997.4118,7.564],
[1997.466,11.203],
[1997.4932,10.062],
[1997.5203,7.707],
[1997.5475,8.348],
[1997.5746,11.1],
[1997.6289,11.134],
[1997.6561,12.871],
[1997.6832,10.449],
[1997.7104,9.917],
[1997.7375,15.41],
[1997.7918,14.713],
[1997.819,12.821],
[1997.8461,11.334],
[1997.8733,8.778],
[1997.9004,11.086],
[1997.9276,14.637],
[1997.9547,11.064],
[1997.9819,10.642],
[1998.009,4.836],
[1998.0362,8.867],
[1998.0905,14.641],
[1998.1176,13.838],
[1998.1448,11.215],
[1998.1719,7.332],
[1998.199,10.44],
[1998.2262,12.259],
[1998.2533,17.455],
[1998.2805,18.071],
[1998.3076,12.577],
[1998.3348,13.316],
[1998.3619,10.54],
[1998.4162,11.899],
[1998.4434,12.371],
[1998.4705,8.131],
[1998.4977,6.536],
[1998.5248,7.123],
[1998.552,7.803],
[1998.6063,7.426],
[1998.6334,4.626],
[1998.6606,6.15],
[1998.6877,6.543],
[1998.7149,9.084],
[1998.742,10.81],
[1998.7692,10.718],
[1998.8235,6.597],
[1998.8506,7.34],
[1998.8777,13.279],
[1998.9049,7.441],
[1998.932,16.685],
[1998.9592,10.903],
[1998.9863,6.795],
[1999.0135,8.942],
[1999.0406,14.817],
[1999.0949,10.334],
[1999.1221,10.304],
[1999.1492,7.871],
[1999.1764,11.024],
[1999.2035,12.406],
[1999.2307,15.677],
[1999.2578,12.094],
[1999.285,9.464],
[1999.3393,10.481],
[1999.3664,12.712],
[1999.3936,11.389],
[1999.4207,13.51],
[1999.4479,7.338],
[1999.475,5.95],
[1999.5022,8.922],
[1999.5293,14.666],
[1999.5565,15.782],
[1999.5836,12.894],
[1999.6107,7.912],
[1999.6379,12.052],
[1999.6922,12.734],
[1999.7193,16.082],
[1999.7465,14.13],
[1999.7736,15.11],
[1999.8008,11.268],
[1999.8279,13.304],
[1999.8551,16.844],
[1999.8822,15.887],
[1999.9094,13.488],
[1999.9637,13.742],
[1999.9908,17.399],
[2000.018,17.65],
[2000.0451,18.022],
[2000.0723,16.355],
[2000.0994,11],
[2000.1266,12.031],
[2000.1537,18.018],
[2000.1809,19.158],
[2000.208,18.623],
[2000.2352,19.687],
[2000.2895,14.592],
[2000.3166,15.316],
[2000.3437,14.385],
[2000.3709,15.582],
[2000.398,14.311],
[2000.4252,11.643],
[2000.4523,10.273],
[2000.4795,13.661],
[2000.5066,15.447],
[2000.5338,17.38],
[2000.5881,8.088],
[2000.6152,14.303],
[2000.6424,17.74],
[2000.6695,16.307],
[2000.6967,15.938],
[2000.7238,18.087],
[2000.751,17.479],
[2000.7781,18.184],
[2000.8053,19.259],
[2000.8596,21.303],
[2000.8867,17.166],
[2000.9139,17.813],
[2000.941,15.017],
[2000.9682,17.625],
[2000.9953,22.132],
[2001.0225,17.937],
[2001.0767,15.296],
[2001.1039,19.227],
[2001.131,20.09],
[2001.1582,24.337],
[2001.1853,24.633],
[2001.2125,18.23],
[2001.2396,19.283],
[2001.2668,20.112],
[2001.2939,24.56],
[2001.3211,24.055],
[2001.3482,20.497],
[2001.3754,18.462],
[2001.4025,16.18],
[2001.4297,17.81],
[2001.4568,20.517],
[2001.484,25.427],
[2001.5111,25.917],
[2001.5383,23.362],
[2001.5654,17.327],
[2001.5926,22.943],
[2001.6197,23.083],
[2001.6469,23.571],
[2001.674,22.788],
[2001.7012,22.059],
[2001.7283,22.456],
[2001.7555,25.017],
[2001.7826,24.099],
[2001.8097,22.529],
[2001.8369,25.875],
[2001.864,23.265],
[2001.8912,20.851],
[2001.9183,20.964],
[2001.9455,21.911],
[2001.9726,24.052],
[2001.9998,24.925],
[2002.0269,18.394],
[2002.0541,19.611],
[2002.0812,27.055],
[2002.1084,29.949],
[2002.1355,28.385],
[2002.1627,23.583],
[2002.1898,18.062],
[2002.217,21.092],
[2002.2441,23.315],
[2002.2713,29.372],
[2002.2984,25.834],
[2002.3256,25.387],
[2002.3527,20.35],
[2002.3799,22.939],
[2002.407,25.769],
[2002.4342,25.936],
[2002.4613,22.874],
[2002.4885,26.314],
[2002.5156,25.565],
[2002.5427,26.095],
[2002.5699,29.736],
[2002.597,33.149],
[2002.6242,33.145],
[2002.6513,26.548],
[2002.6785,22.93],
[2002.7056,25.156],
[2002.7328,30.972],
[2002.7599,29.145],
[2002.7871,30.64],
[2002.8142,30.954],
[2002.8414,23.565],
[2002.8685,25.505],
[2002.8957,33.579],
[2002.9228,30.262],
[2002.95,28.842],
[2002.9771,27.01],
[2003.0043,24.205],
[2003.0314,23.938],
[2003.0586,32.695],
[2003.0857,35.136],
[2003.1129,34.748],
[2003.14,23.93],
[2003.1672,26.367],
[2003.1943,28.848],
[2003.2214,32.035],
[2003.2486,32.729],
[2003.2757,28.107],
[2003.3029,26.485],
[2003.33,26.245],
[2003.3572,26.419],
[2003.3843,30.517],
[2003.4115,31.728],
[2003.4386,25.179],
[2003.4658,25.49],
[2003.4929,24.024],
[2003.5201,26.066],
[2003.5472,31.705],
[2003.5744,31.28],
[2003.6015,29.382],
[2003.6287,23.232],
[2003.6558,25.215],
[2003.683,31.642],
[2003.7101,31.777],
[2003.7373,30.253],
[2003.7644,30.265],
[2003.7916,26.113],
[2003.8187,27.08],
[2003.8459,27.653],
[2003.873,30.403],
[2003.9273,30.268],
[2003.9544,26.936],
[2003.9816,25.228],
[2004.0087,30.548],
[2004.0359,36.158],
[2004.063,36.008],
[2004.0902,32.149],
[2004.1173,20.661],
[2004.1445,31.222],
[2004.1716,31.251],
[2004.1988,34.345],
[2004.2259,33.347],
[2004.2531,31.404],
[2004.2802,28.555],
[2004.3074,34.447],
[2004.3345,28.843],
[2004.3617,30.794],
[2004.3888,28.271],
[2004.416,27.282],
[2004.4431,26.063],
[2004.4703,29.241],
[2004.4974,36.027],
[2004.5246,36.752],
[2004.5517,33.319],
[2004.5789,29.073],
[2004.606,30.21],
[2004.6332,31.942],
[2004.6603,33.902],
[2004.6874,38.766],
[2004.7146,39.003],
[2004.7417,29.247],
[2004.7689,30.892],
[2004.796,30.601],
[2004.8232,32.487],
[2004.8503,35.635],
[2004.8775,35.507],
[2004.9046,29.358],
[2004.9318,30.279],
[2004.9589,33.452],
[2004.9861,42.448],
[2005.0132,36.125],
[2005.0404,33.311],
[2005.0675,33.447],
[2005.0947,32.34],
[2005.1218,35.095],
[2005.149,38.504],
[2005.1761,43.989],
[2005.2033,41.654],
[2005.2304,29.871],
[2005.2576,30.555],
[2005.2847,39.02],
[2005.3119,35.629],
[2005.339,37.36],
[2005.3662,38.327],
[2005.3933,34.937],
[2005.4204,33.855],
[2005.4476,35.732],
[2005.4747,40.191],
[2005.5019,40.197],
[2005.529,38.324],
[2005.5562,33.95],
[2005.5833,37.376],
[2005.6105,34.529],
[2005.6376,36.51],
[2005.6648,40.314],
[2005.6919,36.407],
[2005.7734,36.647],
[2005.8005,38.118],
[2005.8277,38.545],
[2005.8548,40.449],
[2005.882,39.501],
[2005.9091,39.045],
[2005.9363,38.217],
[2005.9634,42.847],
[2005.9906,42.088],
[2006.0177,35.036],
[2006.0449,33.212],
[2006.072,35.692],
[2006.0992,37.595],
[2006.1263,40.021],
[2006.1534,39.484],
[2006.1806,39.978],
[2006.2077,31.279],
[2006.2349,32.45],
[2006.262,37.242],
[2006.2892,39.285],
[2006.3163,36.054],
[2006.3435,33.842],
[2006.3706,36.377],
[2006.3978,39.439],
[2006.4249,37.625],
[2006.4521,40.991],
[2006.4792,42.568],
[2006.5064,39.849],
[2006.5335,37.2],
[2006.5607,39.391],
[2006.5878,42.126],
[2006.615,38.331],
[2006.6421,39.657],
[2006.6693,38.396],
[2006.6964,37.59],
[2006.7236,38.44],
[2006.7507,40.336],
[2006.7779,42.496],
[2006.805,42.72],
[2006.8864,39.637],
[2006.9136,37.873],
[2006.9407,45.232],
[2006.9679,42.113],
[2006.995,36.787],
[2007.0222,33.997],
[2007.0493,32.055],
[2007.0765,39.799],
[2007.1036,40.495],
[2007.1308,38.513],
[2007.1579,40.062],
[2007.1851,33.937],
[2007.2122,35.034],
[2007.2394,40.396],
[2007.2665,45.238],
[2007.2937,41.921],
[2007.3208,37.584],
[2007.348,31.654],
[2007.3751,37.495],
[2007.4023,41.528],
[2007.4294,41.23],
[2007.4566,39.815],
[2007.4837,36.898],
[2007.5109,34.175],
[2007.538,36.137],
[2007.5651,37.793],
[2007.5923,39.356],
[2007.6194,39.871],
[2007.6466,33.315],
[2007.6737,30.437],
[2007.7009,35.055],
[2007.728,39.853],
[2007.7552,41.063],
[2007.7823,38.285],
[2007.8095,35.97],
[2007.8366,34.494],
[2007.8638,40.042],
[2007.8909,44.967],
[2007.9181,43.533],
[2007.9452,41.72],
[2007.9724,33.578],
[2007.9995,33.525],
[2008.0267,38.063],
[2008.0538,43.642],
[2008.081,43.366],
[2008.1081,35.272],
[2008.1353,36.348],
[2008.1624,34.687],
[2008.1896,39.789],
[2008.2167,42.882],
[2008.2439,42.636],
[2008.271,39.468],
[2008.2981,38.305],
[2008.3253,34.694],
[2008.3796,47.621],
[2008.4067,46.895],
[2008.4339,44.059],
[2008.461,42.481],
[2008.4882,43.595],
[2008.5153,44.464],
[2008.5425,45.969],
[2008.5696,44.421],
[2008.5968,40.784],
[2008.6239,40.01],
[2008.6511,39.107],
[2008.6782,41.808],
[2008.7054,41.629],
[2008.7325,43.452],
[2008.7597,41.757],
[2008.7868,39.537],
[2008.814,41.101],
[2008.8411,42.935],
[2008.8683,45.901],
[2008.8954,43.631],
[2008.9226,45.186],
[2008.9497,40.75],
[2008.9769,40.118],
[2009.004,41.364],
[2009.0311,45.131],
[2009.0583,46.863],
[2009.0854,40.098],
[2009.1126,37.202],
[2009.1397,43.524],
[2009.1669,47.053],
[2009.194,48.169],
[2009.2212,48.048],
[2009.2483,44.42],
[2009.2755,41.921],
[2009.3026,43.554],
[2009.3298,47.255],
[2009.3569,50.733],
[2009.3841,44.926],
[2009.4112,40.345],
[2009.4384,42.896],
[2009.4655,45.066],
[2009.4927,45.636],
[2009.5198,44.624],
[2009.547,45.305],
[2009.5741,47.459],
[2009.6013,42.08],
[2009.6284,43.231],
[2009.6556,49.029],
[2009.6827,50.481],
[2009.7099,50.812],
[2009.737,47.293],
[2009.7642,45.469],
[2009.7913,47.57],
[2009.8184,52.21],
[2009.8456,54.418],
[2009.8727,48.86],
[2009.8999,47.517],
[2009.927,45.355],
[2009.9542,47.674],
[2009.9813,53.189],
[2010.0085,49.636],
[2010.0356,46.832],
[2010.0628,44.456],
[2010.0899,41.116],
[2010.1171,47.951],
[2010.1442,54.206],
[2010.1714,55.842],
[2010.1985,47.027],
[2010.2257,44.64],
[2010.2528,45.234],
[2010.28,49.116],
[2010.3071,51.282],
[2010.3343,52.509],
[2010.3614,47.68],
[2010.3886,47.889],
[2010.4157,47.025],
[2010.4429,51.535],
[2010.47,54.363],
[2010.4971,53.381],
[2010.5243,47.987],
[2010.5514,47.694],
[2010.5786,47.132],
[2010.6057,45.524],
[2010.6329,51.781],
[2010.66,45.614],
[2010.6872,43.598],
[2010.7143,42.035],
[2010.7415,41.192],
[2010.7686,43.259],
[2010.7958,50.046],
[2010.8229,48.433],
[2010.8501,44.155],
[2010.8772,41.495],
[2010.9044,39.307],
[2010.9315,45.35],
[2010.9587,46.577],
[2010.9858,46.295],
[2011.013,43.673],
[2011.0401,41.021],
[2011.0673,40.4],
[2011.0944,44.818],
[2011.1216,47.402],
[2011.1487,47.419],
[2011.1759,41.695],
[2011.203,38.922],
[2011.2301,39.755],
[2011.2573,44.408],
[2011.2844,45.552],
[2011.3116,45.327],
[2011.3387,39.87],
[2011.3659,41.584],
[2011.393,43.16],
[2011.4202,45.678],
[2011.4473,50.5],
[2011.4745,50.723],
[2011.5016,45.158],
[2011.5288,44.575],
[2011.5559,46.006],
[2011.5831,48.287],
[2011.6102,54.522],
[2011.6374,51.545],
[2011.6645,48.195],
[2011.6917,46.614],
[2011.7188,46.224],
[2011.746,48.841],
[2011.7731,53.477],
[2011.8003,53.692],
[2011.8274,46.691],
[2011.8546,43.744],
[2011.8817,44.291],
[2011.9089,52.801],
[2011.936,53.19],
[2011.9631,49.49],
[2011.9903,48.985],
[2012.0174,52.292],
[2012.0446,52.974],
[2012.0717,57.82],
[2012.0989,56.953],
[2012.126,55.8],
[2012.1532,51.646],
[2012.1803,47.838],
[2012.2075,52.609],
[2012.2346,58.691],
[2012.2618,55.495],
[2012.2889,53.717],
[2012.3161,51.991],
[2012.3432,51.39],
[2012.3704,55.25],
[2012.3975,55.793],
[2012.4247,57.395],
[2012.4518,59.988],
[2012.479,53.6],
[2012.5061,54.692],
[2012.5333,61.476],
[2012.5604,64.003],
[2012.5876,62.15],
[2012.6147,60.066],
[2012.6419,52.438],
[2012.669,56.444],
[2012.6961,57.787],
[2012.7233,64.646],
[2012.7504,63.243],
[2012.7776,60.095],
[2012.8047,56.322],
[2012.8319,57.4],
[2012.859,59.197],
[2012.8862,62.904],
[2012.9133,63.599],
[2012.9405,61.718],
[2012.9676,58.525],
[2012.9948,61.821],
[2013.0219,62.013],
[2013.0491,64.489],
[2013.0762,64.184],
[2013.1034,61.387]
]).








